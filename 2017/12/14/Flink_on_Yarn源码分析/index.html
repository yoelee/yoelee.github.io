<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">
<meta name="google-site-verification" content="u51Tw-7XO-kfvd_YjNzNs4-HpCBkVQe3St8W8bIKI2w" />









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Flink, YARN, 源码," />










<meta name="description" content="Flink on YARN源码分析(基于1.4版本) liyakun.hit2017-12-14 1. 从命令行开始在Flink上面提交任务需要使用下面的命令：flink_deploy&#x2F;deploy&#x2F;flink-dev&#x2F;bin&#x2F;flink run -d -c com.bytedance.data.Kafka2ElasticSearch -m yarn-clu">
<meta property="og:type" content="article">
<meta property="og:title" content="Flink on YARN源码分析(基于1.4版本)">
<meta property="og:url" content="https://yoelee.github.io/2017/12/14/Flink_on_Yarn%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/index.html">
<meta property="og:site_name" content="亚坤的博客">
<meta property="og:description" content="Flink on YARN源码分析(基于1.4版本) liyakun.hit2017-12-14 1. 从命令行开始在Flink上面提交任务需要使用下面的命令：flink_deploy&#x2F;deploy&#x2F;flink-dev&#x2F;bin&#x2F;flink run -d -c com.bytedance.data.Kafka2ElasticSearch -m yarn-clu">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2017-12-14T02:35:23.000Z">
<meta property="article:modified_time" content="2019-08-23T04:02:46.000Z">
<meta property="article:author" content="亚坤">
<meta property="article:tag" content="Flink, YARN, 源码">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://yoelee.github.io/2017/12/14/Flink_on_Yarn源码分析/"/>





  <title>Flink on YARN源码分析(基于1.4版本) | 亚坤的博客</title>
  








<meta name="generator" content="Hexo 6.3.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">亚坤的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sitemap">
          <a href="/sitemap.xml%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br />
            
            Sitemap
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://yoelee.github.io/2017/12/14/Flink_on_Yarn%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="亚坤的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Flink on YARN源码分析(基于1.4版本)</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-12-14T10:35:23+08:00">
                2017-12-14
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Flink/" itemprop="url" rel="index">
                    <span itemprop="name">Flink</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>Flink on YARN源码分析(基于1.4版本)</p>
<p>liyakun.hit<br>2017-12-14</p>
<h1 id="1-从命令行开始"><a href="#1-从命令行开始" class="headerlink" title="1. 从命令行开始"></a>1. 从命令行开始</h1><p>在Flink上面提交任务需要使用下面的命令：<br>flink_deploy&#x2F;deploy&#x2F;flink-dev&#x2F;bin&#x2F;flink run -d -c com.bytedance.data.Kafka2ElasticSearch -m yarn-cluster -yn 2 -ytm 1024 -yjm 2048 -ys 8 -yqu root.flink_cluster.online ~&#x2F;wordcount&#x2F;target&#x2F;wordcount-1.0-SNAPSHOT.jar<br>先看一下flink_deploy&#x2F;deploy&#x2F;flink-dev&#x2F;bin&#x2F;flink这个脚本，脚本里面前面都是准备工作，最重要的是最后一行命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exec $JAVA_RUN $JVM_ARGS &quot;$&#123;log_setting[@]&#125;&quot; -classpath &quot;`manglePathList &quot;$CC_CLASSPATH:$INTERNAL_HADOOP_CLASSPATHS&quot;`&quot; org.apache.flink.client.CliFrontend &quot;$@&quot;</span><br></pre></td></tr></table></figure>
<p>通过这个命令，可以看到要启动的JAVA主类的入口是：org.apache.flink.client.CliFrontend，然后把参数都传递过去。</p>
<h1 id="2-前端处理"><a href="#2-前端处理" class="headerlink" title="2. 前端处理"></a>2. 前端处理</h1><p>找到CliFrontend的main函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//位置：flink/flink-clients/src/main/java/org/apache/flink/client/CliFrontend.java</span></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Submits the job based on the arguments.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(<span class="keyword">final</span> String[] args)</span> &#123;</span><br><span class="line">		EnvironmentInformation.logEnvironmentInfo(LOG, <span class="string">&quot;Command Line Client&quot;</span>, args);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">final</span> <span class="type">CliFrontend</span> <span class="variable">cli</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CliFrontend</span>();</span><br><span class="line">			SecurityUtils.install(<span class="keyword">new</span> <span class="title class_">SecurityUtils</span>.SecurityConfiguration(cli.config));</span><br><span class="line">			<span class="type">int</span> <span class="variable">retCode</span> <span class="operator">=</span> SecurityUtils.getInstalledContext()</span><br><span class="line">					.runSecured(<span class="keyword">new</span> <span class="title class_">Callable</span>&lt;Integer&gt;() &#123;</span><br><span class="line">						<span class="meta">@Override</span></span><br><span class="line">						<span class="keyword">public</span> Integer <span class="title function_">call</span><span class="params">()</span> &#123;</span><br><span class="line">							<span class="keyword">return</span> cli.parseParameters(args);</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;);</span><br><span class="line">			System.exit(retCode);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">			LOG.error(<span class="string">&quot;Fatal error while running command line interface.&quot;</span>, t);</span><br><span class="line">			t.printStackTrace();</span><br><span class="line">			System.exit(<span class="number">31</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>这段代码主要是创建了一个CliFrontend类的实例cli，然后新启动一个线程来执行cli.parseParameters(args)，下面继续跟进：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//位置：flink/flink-clients/src/main/java/org/apache/flink/client/CliFrontend.java</span></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Parses the command line arguments and starts the requested action.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> args command line arguments of the client.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> The return code of the program</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="type">int</span> <span class="title function_">parseParameters</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">...</span><br><span class="line">		<span class="comment">// do action</span></span><br><span class="line">		<span class="keyword">switch</span> (action) &#123;</span><br><span class="line">			<span class="keyword">case</span> ACTION_RUN:</span><br><span class="line">				<span class="keyword">return</span> run(params);</span><br><span class="line">			<span class="keyword">case</span> ACTION_LIST:</span><br><span class="line">				<span class="keyword">return</span> list(params);</span><br><span class="line">			<span class="keyword">case</span> ACTION_INFO:</span><br><span class="line">				<span class="keyword">return</span> info(params);</span><br><span class="line">			<span class="keyword">case</span> ACTION_CANCEL:</span><br><span class="line">				<span class="keyword">return</span> cancel(params);</span><br><span class="line">			<span class="keyword">case</span> ACTION_STOP:</span><br><span class="line">				<span class="keyword">return</span> stop(params);</span><br><span class="line">			<span class="keyword">case</span> ACTION_SAVEPOINT:</span><br><span class="line">				<span class="keyword">return</span> savepoint(params);</span><br><span class="line">...</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>这里最重要的处理是调用ACTION_RUN条件下面的run(params)方法，(这里同时还有其它的命令分支，比如list,info,cancel,stop等)，这里沿着run命令继续跟进到run方法内部：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//位置：flink/flink-clients/src/main/java/org/apache/flink/client/CliFrontend.java</span></span><br><span class="line">	<span class="keyword">protected</span> <span class="type">int</span> <span class="title function_">run</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">...</span><br><span class="line">		<span class="type">ClusterClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">			client = createClient(options, program);</span><br><span class="line">			client.setPrintStatusDuringExecution(options.getStdoutLogging());</span><br><span class="line">			client.setDetached(options.getDetachedMode());</span><br><span class="line">			LOG.debug(<span class="string">&quot;Client slots is set to &#123;&#125;&quot;</span>, client.getMaxSlots());</span><br><span class="line"></span><br><span class="line">			LOG.debug(options.getSavepointRestoreSettings().toString());</span><br><span class="line"></span><br><span class="line">			<span class="type">int</span> <span class="variable">userParallelism</span> <span class="operator">=</span> options.getParallelism();</span><br><span class="line">			LOG.debug(<span class="string">&quot;User parallelism is set to &#123;&#125;&quot;</span>, userParallelism);</span><br><span class="line">			<span class="keyword">if</span> (client.getMaxSlots() != -<span class="number">1</span> &amp;&amp; userParallelism == -<span class="number">1</span>) &#123;</span><br><span class="line">				logAndSysout(<span class="string">&quot;Using the parallelism provided by the remote cluster (&quot;</span></span><br><span class="line">					+ client.getMaxSlots() + <span class="string">&quot;). &quot;</span></span><br><span class="line">					+ <span class="string">&quot;To use another parallelism, set it at the ./bin/flink client.&quot;</span>);</span><br><span class="line">				userParallelism = client.getMaxSlots();</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">return</span> executeProgram(program, client, userParallelism);</span><br><span class="line">		&#125;</span><br><span class="line">...</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>这里首先是创建了一个ClusterClient类的实例client，这个createClient()方法会选择一个合适的ClusterClient的实现类，然后返回它的实例。这个函数里面会处理与YARN的交互，过程比较长，下面跟进分析到createClient里面（之后再继续分析当前方法内部的剩余源码）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//位置：flink/flink-clients/src/main/java/org/apache/flink/client/CliFrontend.java</span></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Creates a &#123;<span class="doctag">@link</span> ClusterClient&#125; object from the given command line options and other parameters.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> options Command line options</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> program The program for which to create the client.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">protected</span> ClusterClient <span class="title function_">createClient</span><span class="params">(</span></span><br><span class="line"><span class="params">			CommandLineOptions options,</span></span><br><span class="line"><span class="params">			PackagedProgram program)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Get the custom command-line (e.g. Standalone/Yarn/Mesos)</span></span><br><span class="line">		CustomCommandLine&lt;?&gt; activeCommandLine = getActiveCustomCommandLine(options.getCommandLine());</span><br><span class="line"></span><br><span class="line">		ClusterClient client;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			client = activeCommandLine.retrieveCluster(options.getCommandLine(), config);</span><br><span class="line">			logAndSysout(<span class="string">&quot;Cluster configuration: &quot;</span> + client.getClusterIdentifier());</span><br><span class="line">		&#125; <span class="keyword">catch</span> (UnsupportedOperationException e) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				<span class="type">String</span> <span class="variable">applicationName</span> <span class="operator">=</span> <span class="string">&quot;Flink Application: &quot;</span> + program.getMainClassName();</span><br><span class="line">				client = activeCommandLine.createCluster(</span><br><span class="line">					applicationName,</span><br><span class="line">					options.getCommandLine(),</span><br><span class="line">					config,</span><br><span class="line">					program.getAllLibraries());</span><br><span class="line">				logAndSysout(<span class="string">&quot;Cluster started: &quot;</span> + client.getClusterIdentifier());</span><br><span class="line">			&#125; <span class="keyword">catch</span> (UnsupportedOperationException e2) &#123;</span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalConfigurationException</span>(</span><br><span class="line">					<span class="string">&quot;The JobManager address is neither provided at the command-line, &quot;</span> +</span><br><span class="line">						<span class="string">&quot;nor configured in flink-conf.yaml.&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Avoid resolving the JobManager Gateway here to prevent blocking until we invoke the user&#x27;s program.</span></span><br><span class="line">		<span class="keyword">final</span> <span class="type">InetSocketAddress</span> <span class="variable">jobManagerAddress</span> <span class="operator">=</span> client.getJobManagerAddress();</span><br><span class="line">		logAndSysout(<span class="string">&quot;Using address &quot;</span> + jobManagerAddress.getHostString() + <span class="string">&quot;:&quot;</span> + jobManagerAddress.getPort() + <span class="string">&quot; to connect to JobManager.&quot;</span>);</span><br><span class="line">		logAndSysout(<span class="string">&quot;JobManager web interface address &quot;</span> + client.getWebInterfaceURL());</span><br><span class="line">		<span class="keyword">return</span> client;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>这里getActiveCustomCommandLine方法是根据-m参数来获得一个CustomCommandLine的实现类，这里由于之前的命令里面指定的是-m yarn-cluster，所以最终选择的是：FlinkYarnSessionCli这个类。然后使用FlinkYarnSessionCli这个类的retrieveCluster方法找一下是否已经提交过这个应用了(这在通过flink命令查询应用状态时成立)，这里因为是新提交的应用，所以找不到，会抛出UnsupportedOperationException异常，然后程序接住这个异常，通过调用activeCommandLine.createCluster()方法来创建一个client对象。</p>
<h1 id="3-与Yarn交互"><a href="#3-与Yarn交互" class="headerlink" title="3. 与Yarn交互"></a>3. 与Yarn交互</h1><p>下面继续跟进到createCluster方法内部：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//位置：flink/flink-yarn/src/main/java/org/apache/flink/yarn/cli/FlinkYarnSessionCli.java</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> YarnClusterClient <span class="title function_">createCluster</span><span class="params">(</span></span><br><span class="line"><span class="params">			String applicationName,</span></span><br><span class="line"><span class="params">			CommandLine cmdLine,</span></span><br><span class="line"><span class="params">			Configuration config,</span></span><br><span class="line"><span class="params">			List&lt;URL&gt; userJarFiles)</span> &#123;</span><br><span class="line">		Preconditions.checkNotNull(userJarFiles, <span class="string">&quot;User jar files should not be null.&quot;</span>);</span><br><span class="line"></span><br><span class="line">		<span class="type">AbstractYarnClusterDescriptor</span> <span class="variable">yarnClusterDescriptor</span> <span class="operator">=</span> createDescriptor(applicationName, cmdLine);</span><br><span class="line">		yarnClusterDescriptor.setFlinkConfiguration(config);</span><br><span class="line">		yarnClusterDescriptor.setProvidedUserJarFiles(userJarFiles);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> yarnClusterDescriptor.deploy();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Error deploying the YARN cluster&quot;</span>, e);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>首先看一下createDescriptor方法，从结果上来看它创建了一个AbstractYarnClusterDescriptor的实例yarnClusterDescriptor。这里不再跟进到createDescriptor方法内部了，只是简单在这里介绍一下吧。 yarnClusterDescriptor其实是YarnClusterDescriptor的实例，其对象内部添加了如下信息：</p>
<ul>
<li>taskmananger的数量</li>
<li>本地jar路径</li>
<li>需要传输的文件</li>
<li>要使用的yarn的队列</li>
<li>jobmanager的占用内存数</li>
<li>taskmanager的占用内存数</li>
<li>taskmanager的slot数</li>
<li>dynamicproperties</li>
<li>detached模式</li>
<li>应用名</li>
<li>使用的zk的namespace</li>
<li>Flink的config</li>
<li>用户的jar文件</li>
</ul>
<p>最后一行调用了yarnClusterDescriptor.deploy()方法，继续跟进：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//位置：flink/flink-yarn/src/main/java/org/apache/flink/yarn/AbstractYarnClusterDescriptor.java</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> YarnClusterClient <span class="title function_">deploy</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (UserGroupInformation.isSecurityEnabled()) &#123;</span><br><span class="line">				<span class="comment">// note: UGI::hasKerberosCredentials inaccurately reports false</span></span><br><span class="line">				<span class="comment">// for logins based on a keytab (fixed in Hadoop 2.6.1, see HADOOP-10786),</span></span><br><span class="line">				<span class="comment">// so we check only in ticket cache scenario.</span></span><br><span class="line">				<span class="type">boolean</span> <span class="variable">useTicketCache</span> <span class="operator">=</span> flinkConfiguration.getBoolean(SecurityOptions.KERBEROS_LOGIN_USETICKETCACHE);</span><br><span class="line"></span><br><span class="line">				<span class="type">UserGroupInformation</span> <span class="variable">loginUser</span> <span class="operator">=</span> UserGroupInformation.getCurrentUser();</span><br><span class="line">				<span class="keyword">if</span> (loginUser.getAuthenticationMethod() == UserGroupInformation.AuthenticationMethod.KERBEROS</span><br><span class="line">						&amp;&amp; useTicketCache &amp;&amp; !loginUser.hasKerberosCredentials()) &#123;</span><br><span class="line">					LOG.error(<span class="string">&quot;Hadoop security with Kerberos is enabled but the login user does not have Kerberos credentials&quot;</span>);</span><br><span class="line">					<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Hadoop security with Kerberos is enabled but the login user &quot;</span> +</span><br><span class="line">							<span class="string">&quot;does not have Kerberos credentials&quot;</span>);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> deployInternal();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Couldn&#x27;t deploy Yarn cluster&quot;</span>, e);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>这里主要是进行了认证相关的工作，跳过它直接看接下来的deployInternal()函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//位置：flink/flink-yarn/src/main/java/org/apache/flink/yarn/AbstractYarnClusterDescriptor.java</span></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * This method will block until the ApplicationMaster/JobManager have been</span></span><br><span class="line"><span class="comment">	 * deployed on YARN.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">protected</span> YarnClusterClient <span class="title function_">deployInternal</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		isReadyForDeployment();</span><br><span class="line">		LOG.info(<span class="string">&quot;Using values:&quot;</span>);</span><br><span class="line">		LOG.info(<span class="string">&quot;\tTaskManager count = &#123;&#125;&quot;</span>, taskManagerCount);</span><br><span class="line">		LOG.info(<span class="string">&quot;\tJobManager memory = &#123;&#125;&quot;</span>, jobManagerMemoryMb);</span><br><span class="line">		LOG.info(<span class="string">&quot;\tTaskManager memory = &#123;&#125;&quot;</span>, taskManagerMemoryMb);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">final</span> <span class="type">YarnClient</span> <span class="variable">yarnClient</span> <span class="operator">=</span> getYarnClient();</span><br><span class="line"></span><br><span class="line">		<span class="comment">// ------------------ Check if the specified queue exists --------------------</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			List&lt;QueueInfo&gt; queues = yarnClient.getAllQueues();</span><br><span class="line">			<span class="keyword">if</span> (queues.size() &gt; <span class="number">0</span> &amp;&amp; <span class="built_in">this</span>.yarnQueue != <span class="literal">null</span>) &#123; <span class="comment">// check only if there are queues configured in yarn and for this session.</span></span><br><span class="line">				<span class="type">boolean</span> <span class="variable">queueFound</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">				<span class="keyword">for</span> (QueueInfo queue : queues) &#123;</span><br><span class="line">					<span class="keyword">if</span> (queue.getQueueName().equals(<span class="built_in">this</span>.yarnQueue)) &#123;</span><br><span class="line">						queueFound = <span class="literal">true</span>;</span><br><span class="line">						<span class="keyword">break</span>;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span> (!queueFound) &#123;</span><br><span class="line">					<span class="type">String</span> <span class="variable">queueNames</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">					<span class="keyword">for</span> (QueueInfo queue : queues) &#123;</span><br><span class="line">						queueNames += queue.getQueueName() + <span class="string">&quot;, &quot;</span>;</span><br><span class="line">					&#125;</span><br><span class="line">					LOG.warn(<span class="string">&quot;The specified queue &#x27;&quot;</span> + <span class="built_in">this</span>.yarnQueue + <span class="string">&quot;&#x27; does not exist. &quot;</span> +</span><br><span class="line">						<span class="string">&quot;Available queues: &quot;</span> + queueNames);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				LOG.debug(<span class="string">&quot;The YARN cluster does not have any queues configured&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">			LOG.warn(<span class="string">&quot;Error while getting queue information from YARN: &quot;</span> + e.getMessage());</span><br><span class="line">			<span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">				LOG.debug(<span class="string">&quot;Error details&quot;</span>, e);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// ------------------ Add dynamic properties to local flinkConfiguraton ------</span></span><br><span class="line">		Map&lt;String, String&gt; dynProperties = getDynamicProperties(dynamicPropertiesEncoded);</span><br><span class="line">		<span class="keyword">for</span> (Map.Entry&lt;String, String&gt; dynProperty : dynProperties.entrySet()) &#123;</span><br><span class="line">			flinkConfiguration.setString(dynProperty.getKey(), dynProperty.getValue());</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// ------------------ Check if the YARN ClusterClient has the requested resources --------------</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">// the yarnMinAllocationMB specifies the smallest possible container allocation size.</span></span><br><span class="line">		<span class="comment">// all allocations below this value are automatically set to this value.</span></span><br><span class="line">		<span class="keyword">final</span> <span class="type">int</span> <span class="variable">yarnMinAllocationMB</span> <span class="operator">=</span> conf.getInt(<span class="string">&quot;yarn.scheduler.minimum-allocation-mb&quot;</span>, <span class="number">0</span>);</span><br><span class="line">		<span class="keyword">if</span> (jobManagerMemoryMb &lt; yarnMinAllocationMB || taskManagerMemoryMb &lt; yarnMinAllocationMB) &#123;</span><br><span class="line">			LOG.warn(<span class="string">&quot;The JobManager or TaskManager memory is below the smallest possible YARN Container size. &quot;</span></span><br><span class="line">				+ <span class="string">&quot;The value of &#x27;yarn.scheduler.minimum-allocation-mb&#x27; is &#x27;&quot;</span> + yarnMinAllocationMB + <span class="string">&quot;&#x27;. Please increase the memory size.&quot;</span> +</span><br><span class="line">				<span class="string">&quot;YARN will allocate the smaller containers but the scheduler will account for the minimum-allocation-mb, maybe not all instances &quot;</span> +</span><br><span class="line">				<span class="string">&quot;you requested will start.&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// set the memory to minAllocationMB to do the next checks correctly</span></span><br><span class="line">		<span class="keyword">if</span> (jobManagerMemoryMb &lt; yarnMinAllocationMB) &#123;</span><br><span class="line">			jobManagerMemoryMb =  yarnMinAllocationMB;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (taskManagerMemoryMb &lt; yarnMinAllocationMB) &#123;</span><br><span class="line">			taskManagerMemoryMb =  yarnMinAllocationMB;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Create application via yarnClient</span></span><br><span class="line">		<span class="keyword">final</span> <span class="type">YarnClientApplication</span> <span class="variable">yarnApplication</span> <span class="operator">=</span> yarnClient.createApplication();</span><br><span class="line">		<span class="type">GetNewApplicationResponse</span> <span class="variable">appResponse</span> <span class="operator">=</span> yarnApplication.getNewApplicationResponse();</span><br><span class="line"></span><br><span class="line">		<span class="type">Resource</span> <span class="variable">maxRes</span> <span class="operator">=</span> appResponse.getMaximumResourceCapability();</span><br><span class="line">		<span class="keyword">final</span> <span class="type">String</span> <span class="variable">note</span> <span class="operator">=</span> <span class="string">&quot;Please check the &#x27;yarn.scheduler.maximum-allocation-mb&#x27; and the &#x27;yarn.nodemanager.resource.memory-mb&#x27; configuration values\n&quot;</span>;</span><br><span class="line">		<span class="keyword">if</span> (jobManagerMemoryMb &gt; maxRes.getMemory()) &#123;</span><br><span class="line">			failSessionDuringDeployment(yarnClient, yarnApplication);</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">YarnDeploymentException</span>(<span class="string">&quot;The cluster does not have the requested resources for the JobManager available!\n&quot;</span></span><br><span class="line">				+ <span class="string">&quot;Maximum Memory: &quot;</span> + maxRes.getMemory() + <span class="string">&quot;MB Requested: &quot;</span> + jobManagerMemoryMb + <span class="string">&quot;MB. &quot;</span> + note);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (taskManagerMemoryMb &gt; maxRes.getMemory()) &#123;</span><br><span class="line">			failSessionDuringDeployment(yarnClient, yarnApplication);</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">YarnDeploymentException</span>(<span class="string">&quot;The cluster does not have the requested resources for the TaskManagers available!\n&quot;</span></span><br><span class="line">				+ <span class="string">&quot;Maximum Memory: &quot;</span> + maxRes.getMemory() + <span class="string">&quot; Requested: &quot;</span> + taskManagerMemoryMb + <span class="string">&quot;MB. &quot;</span> + note);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">final</span> <span class="type">String</span> <span class="variable">noteRsc</span> <span class="operator">=</span> <span class="string">&quot;\nThe Flink YARN client will try to allocate the YARN session, but maybe not all TaskManagers are &quot;</span> +</span><br><span class="line">			<span class="string">&quot;connecting from the beginning because the resources are currently not available in the cluster. &quot;</span> +</span><br><span class="line">			<span class="string">&quot;The allocation might take more time than usual because the Flink YARN client needs to wait until &quot;</span> +</span><br><span class="line">			<span class="string">&quot;the resources become available.&quot;</span>;</span><br><span class="line">		<span class="type">int</span> <span class="variable">totalMemoryRequired</span> <span class="operator">=</span> jobManagerMemoryMb + taskManagerMemoryMb * taskManagerCount;</span><br><span class="line">		<span class="type">ClusterResourceDescription</span> <span class="variable">freeClusterMem</span> <span class="operator">=</span> getCurrentFreeClusterResources(yarnClient);</span><br><span class="line">		<span class="keyword">if</span> (freeClusterMem.totalFreeMemory &lt; totalMemoryRequired) &#123;</span><br><span class="line">			LOG.warn(<span class="string">&quot;This YARN session requires &quot;</span> + totalMemoryRequired + <span class="string">&quot;MB of memory in the cluster. &quot;</span></span><br><span class="line">				+ <span class="string">&quot;There are currently only &quot;</span> + freeClusterMem.totalFreeMemory + <span class="string">&quot;MB available.&quot;</span> + noteRsc);</span><br><span class="line"></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (taskManagerMemoryMb &gt; freeClusterMem.containerLimit) &#123;</span><br><span class="line">			LOG.warn(<span class="string">&quot;The requested amount of memory for the TaskManagers (&quot;</span> + taskManagerMemoryMb + <span class="string">&quot;MB) is more than &quot;</span></span><br><span class="line">				+ <span class="string">&quot;the largest possible YARN container: &quot;</span> + freeClusterMem.containerLimit + noteRsc);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (jobManagerMemoryMb &gt; freeClusterMem.containerLimit) &#123;</span><br><span class="line">			LOG.warn(<span class="string">&quot;The requested amount of memory for the JobManager (&quot;</span> + jobManagerMemoryMb + <span class="string">&quot;MB) is more than &quot;</span></span><br><span class="line">				+ <span class="string">&quot;the largest possible YARN container: &quot;</span> + freeClusterMem.containerLimit + noteRsc);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// ----------------- check if the requested containers fit into the cluster.</span></span><br><span class="line"></span><br><span class="line">		<span class="type">int</span>[] nmFree = Arrays.copyOf(freeClusterMem.nodeManagersFree, freeClusterMem.nodeManagersFree.length);</span><br><span class="line">		<span class="comment">// first, allocate the jobManager somewhere.</span></span><br><span class="line">		<span class="keyword">if</span> (!allocateResource(nmFree, jobManagerMemoryMb)) &#123;</span><br><span class="line">			LOG.warn(<span class="string">&quot;Unable to find a NodeManager that can fit the JobManager/Application master. &quot;</span> +</span><br><span class="line">				<span class="string">&quot;The JobManager requires &quot;</span> + jobManagerMemoryMb + <span class="string">&quot;MB. NodeManagers available: &quot;</span> +</span><br><span class="line">				Arrays.toString(freeClusterMem.nodeManagersFree) + noteRsc);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// allocate TaskManagers</span></span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; taskManagerCount; i++) &#123;</span><br><span class="line">			<span class="keyword">if</span> (!allocateResource(nmFree, taskManagerMemoryMb)) &#123;</span><br><span class="line">				LOG.warn(<span class="string">&quot;There is not enough memory available in the YARN cluster. &quot;</span> +</span><br><span class="line">					<span class="string">&quot;The TaskManager(s) require &quot;</span> + taskManagerMemoryMb + <span class="string">&quot;MB each. &quot;</span> +</span><br><span class="line">					<span class="string">&quot;NodeManagers available: &quot;</span> + Arrays.toString(freeClusterMem.nodeManagersFree) + <span class="string">&quot;\n&quot;</span> +</span><br><span class="line">					<span class="string">&quot;After allocating the JobManager (&quot;</span> + jobManagerMemoryMb + <span class="string">&quot;MB) and (&quot;</span> + i + <span class="string">&quot;/&quot;</span> + taskManagerCount + <span class="string">&quot;) TaskManagers, &quot;</span> +</span><br><span class="line">					<span class="string">&quot;the following NodeManagers are available: &quot;</span> + Arrays.toString(nmFree)  + noteRsc);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="type">ApplicationReport</span> <span class="variable">report</span> <span class="operator">=</span> startAppMaster(<span class="literal">null</span>, yarnClient, yarnApplication);</span><br><span class="line"></span><br><span class="line">		<span class="type">String</span> <span class="variable">host</span> <span class="operator">=</span> report.getHost();</span><br><span class="line">		<span class="type">int</span> <span class="variable">port</span> <span class="operator">=</span> report.getRpcPort();</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Correctly initialize the Flink config</span></span><br><span class="line">		flinkConfiguration.setString(ConfigConstants.JOB_MANAGER_IPC_ADDRESS_KEY, host);</span><br><span class="line">		flinkConfiguration.setInteger(ConfigConstants.JOB_MANAGER_IPC_PORT_KEY, port);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// the Flink cluster is deployed in YARN. Represent cluster</span></span><br><span class="line">		<span class="keyword">return</span> createYarnClusterClient(<span class="built_in">this</span>, yarnClient, report, flinkConfiguration, <span class="literal">true</span>);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>这个方法是一个非常关键的步骤。ApplicationMaster&#x2F;JobManager会在这里启动。下面仔细分析一下：</p>
<ul>
<li>首先是根据一些配置详情判定一下是否可以部署。</li>
<li>然后通过getYarnClient方法，产生一个yarnClient对象，这个对象负责跟YARN的ResourceManager进行交互。</li>
<li>然后获取一下声明的队列是否存在</li>
<li>添加一些动态属性到flink的配置中</li>
<li>判断一下Yarn配置里面的container的最大最小内存能否满足本次申请</li>
<li>调用yarnClient.createApplication()方法来向RM申请创建一个YarnClientApplication的实例</li>
<li>通过appResponse里面最大能提供的资源与需求进行对比，判定能否满足需求</li>
<li>接下就是调用startAppMaster方法来启动真正的appmaster了，这个方法稍后跟进，先继续往下看。</li>
<li>在appmaster启动后，把返回结果封闭进一个YarnClusterClient类的实例中返回回去。这里也就是返回到flink&#x2F;flink-clients&#x2F;src&#x2F;main&#x2F;java&#x2F;org&#x2F;apache&#x2F;flink&#x2F;client&#x2F;CliFrontend.java的createClient()方法。</li>
</ul>
<p>下面跟进到startAppMaster方法内部，这个方法非常重要，也非常长。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//位置：flink/flink-yarn/src/main/java/org/apache/flink/yarn/AbstractYarnClusterDescriptor.java</span></span><br><span class="line">	<span class="keyword">public</span> ApplicationReport <span class="title function_">startAppMaster</span><span class="params">(JobGraph jobGraph, YarnClient yarnClient, YarnClientApplication yarnApplication)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// ------------------ Set default file system scheme -------------------------</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			org.apache.flink.core.fs.FileSystem.setDefaultScheme(flinkConfiguration);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IOException</span>(<span class="string">&quot;Error while setting the default &quot;</span> +</span><br><span class="line">					<span class="string">&quot;filesystem scheme from configuration.&quot;</span>, e);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// initialize file system</span></span><br><span class="line">		<span class="comment">// Copy the application master jar to the filesystem</span></span><br><span class="line">		<span class="comment">// Create a local resource to point to the destination jar path</span></span><br><span class="line">		<span class="keyword">final</span> <span class="type">FileSystem</span> <span class="variable">fs</span> <span class="operator">=</span> FileSystem.get(conf);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// hard coded check for the GoogleHDFS client because its not overriding the getScheme() method.</span></span><br><span class="line">		<span class="keyword">if</span> (!fs.getClass().getSimpleName().equals(<span class="string">&quot;GoogleHadoopFileSystem&quot;</span>) &amp;&amp;</span><br><span class="line">				fs.getScheme().startsWith(<span class="string">&quot;file&quot;</span>)) &#123;</span><br><span class="line">			LOG.warn(<span class="string">&quot;The file system scheme is &#x27;&quot;</span> + fs.getScheme() + <span class="string">&quot;&#x27;. This indicates that the &quot;</span></span><br><span class="line">					+ <span class="string">&quot;specified Hadoop configuration path is wrong and the system is using the default Hadoop configuration values.&quot;</span></span><br><span class="line">					+ <span class="string">&quot;The Flink YARN client needs to store its files in a distributed file system&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="type">ApplicationSubmissionContext</span> <span class="variable">appContext</span> <span class="operator">=</span> yarnApplication.getApplicationSubmissionContext();</span><br><span class="line">		Set&lt;File&gt; systemShipFiles = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;(shipFiles.size());</span><br><span class="line">		<span class="keyword">for</span> (File file : shipFiles) &#123;</span><br><span class="line">			systemShipFiles.add(file.getAbsoluteFile());</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//check if there is a logback or log4j file</span></span><br><span class="line">		<span class="type">File</span> <span class="variable">logbackFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(configurationDirectory + File.separator + CONFIG_FILE_LOGBACK_NAME);</span><br><span class="line">		<span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">hasLogback</span> <span class="operator">=</span> logbackFile.exists();</span><br><span class="line">		<span class="keyword">if</span> (hasLogback) &#123;</span><br><span class="line">			systemShipFiles.add(logbackFile);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="type">File</span> <span class="variable">log4jFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(configurationDirectory + File.separator + CONFIG_FILE_LOG4J_NAME);</span><br><span class="line">		<span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">hasLog4j</span> <span class="operator">=</span> log4jFile.exists();</span><br><span class="line">		<span class="keyword">if</span> (hasLog4j) &#123;</span><br><span class="line">			systemShipFiles.add(log4jFile);</span><br><span class="line">			<span class="keyword">if</span> (hasLogback) &#123;</span><br><span class="line">				<span class="comment">// this means there is already a logback configuration file --&gt; fail</span></span><br><span class="line">				LOG.warn(<span class="string">&quot;The configuration directory (&#x27;&quot;</span> + configurationDirectory + <span class="string">&quot;&#x27;) contains both LOG4J and &quot;</span> +</span><br><span class="line">					<span class="string">&quot;Logback configuration files. Please delete or rename one of them.&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		addLibFolderToShipFiles(systemShipFiles);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Set-up ApplicationSubmissionContext for the application</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">final</span> <span class="type">ApplicationId</span> <span class="variable">appId</span> <span class="operator">=</span> appContext.getApplicationId();</span><br><span class="line"></span><br><span class="line">		<span class="comment">// ------------------ Add Zookeeper namespace to local flinkConfiguraton ------</span></span><br><span class="line">		<span class="type">String</span> <span class="variable">zkNamespace</span> <span class="operator">=</span> getZookeeperNamespace();</span><br><span class="line">		<span class="comment">// no user specified cli argument for namespace?</span></span><br><span class="line">		<span class="keyword">if</span> (zkNamespace == <span class="literal">null</span> || zkNamespace.isEmpty()) &#123;</span><br><span class="line">			<span class="comment">// namespace defined in config? else use applicationId as default.</span></span><br><span class="line">			zkNamespace = flinkConfiguration.getString(HighAvailabilityOptions.HA_CLUSTER_ID, String.valueOf(appId));</span><br><span class="line">			setZookeeperNamespace(zkNamespace);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		flinkConfiguration.setString(HighAvailabilityOptions.HA_CLUSTER_ID, zkNamespace);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (HighAvailabilityMode.isHighAvailabilityModeActivated(flinkConfiguration)) &#123;</span><br><span class="line">			<span class="comment">// activate re-execution of failed applications</span></span><br><span class="line">			appContext.setMaxAppAttempts(</span><br><span class="line">				flinkConfiguration.getInteger(</span><br><span class="line">					ConfigConstants.YARN_APPLICATION_ATTEMPTS,</span><br><span class="line">					YarnConfiguration.DEFAULT_RM_AM_MAX_ATTEMPTS));</span><br><span class="line"></span><br><span class="line">			activateHighAvailabilitySupport(appContext);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">// set number of application retries to 1 in the default case</span></span><br><span class="line">			appContext.setMaxAppAttempts(</span><br><span class="line">				flinkConfiguration.getInteger(</span><br><span class="line">					ConfigConstants.YARN_APPLICATION_ATTEMPTS,</span><br><span class="line">					<span class="number">1</span>));</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// local resource map for Yarn</span></span><br><span class="line">		<span class="keyword">final</span> Map&lt;String, LocalResource&gt; localResources = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">2</span> + systemShipFiles.size() + userJarFiles.size());</span><br><span class="line">		<span class="comment">// list of remote paths (after upload)</span></span><br><span class="line">		<span class="keyword">final</span> List&lt;Path&gt; paths = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(<span class="number">2</span> + systemShipFiles.size() + userJarFiles.size());</span><br><span class="line">		<span class="comment">// ship list that enables reuse of resources for task manager containers</span></span><br><span class="line">		<span class="type">StringBuilder</span> <span class="variable">envShipFileList</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line"></span><br><span class="line">		<span class="comment">// upload and register ship files</span></span><br><span class="line">		List&lt;String&gt; systemClassPaths = uploadAndRegisterFiles(systemShipFiles, fs, appId.toString(), paths, localResources, envShipFileList);</span><br><span class="line"></span><br><span class="line">		List&lt;String&gt; userClassPaths;</span><br><span class="line">		<span class="keyword">if</span> (userJarInclusion != YarnConfigOptions.UserJarInclusion.DISABLED) &#123;</span><br><span class="line">			userClassPaths = uploadAndRegisterFiles(userJarFiles, fs, appId.toString(), paths, localResources, envShipFileList);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			userClassPaths = Collections.emptyList();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (userJarInclusion == YarnConfigOptions.UserJarInclusion.ORDER) &#123;</span><br><span class="line">			systemClassPaths.addAll(userClassPaths);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// normalize classpath by sorting</span></span><br><span class="line">		Collections.sort(systemClassPaths);</span><br><span class="line">		Collections.sort(userClassPaths);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// classpath assembler</span></span><br><span class="line">		<span class="type">StringBuilder</span> <span class="variable">classPathBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">		<span class="keyword">if</span> (userJarInclusion == YarnConfigOptions.UserJarInclusion.FIRST) &#123;</span><br><span class="line">			<span class="keyword">for</span> (String userClassPath : userClassPaths) &#123;</span><br><span class="line">				classPathBuilder.append(userClassPath).append(File.pathSeparator);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">for</span> (String classPath : systemClassPaths) &#123;</span><br><span class="line">			classPathBuilder.append(classPath).append(File.pathSeparator);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (userJarInclusion == YarnConfigOptions.UserJarInclusion.LAST) &#123;</span><br><span class="line">			<span class="keyword">for</span> (String userClassPath : userClassPaths) &#123;</span><br><span class="line">				classPathBuilder.append(userClassPath).append(File.pathSeparator);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Setup jar for ApplicationMaster</span></span><br><span class="line">		<span class="type">LocalResource</span> <span class="variable">appMasterJar</span> <span class="operator">=</span> Records.newRecord(LocalResource.class);</span><br><span class="line">		<span class="type">LocalResource</span> <span class="variable">flinkConf</span> <span class="operator">=</span> Records.newRecord(LocalResource.class);</span><br><span class="line">		<span class="type">Path</span> <span class="variable">remotePathJar</span> <span class="operator">=</span></span><br><span class="line">			Utils.setupLocalResource(fs, appId.toString(), flinkJarPath, appMasterJar, fs.getHomeDirectory());</span><br><span class="line">		<span class="type">Path</span> <span class="variable">remotePathConf</span> <span class="operator">=</span></span><br><span class="line">			Utils.setupLocalResource(fs, appId.toString(), flinkConfigurationPath, flinkConf, fs.getHomeDirectory());</span><br><span class="line">		localResources.put(<span class="string">&quot;flink.jar&quot;</span>, appMasterJar);</span><br><span class="line">		localResources.put(<span class="string">&quot;flink-conf.yaml&quot;</span>, flinkConf);</span><br><span class="line"></span><br><span class="line">		paths.add(remotePathJar);</span><br><span class="line">		classPathBuilder.append(<span class="string">&quot;flink.jar&quot;</span>).append(File.pathSeparator);</span><br><span class="line">		paths.add(remotePathConf);</span><br><span class="line">		classPathBuilder.append(<span class="string">&quot;flink-conf.yaml&quot;</span>).append(File.pathSeparator);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// write job graph to tmp file and add it to local resource</span></span><br><span class="line">		<span class="comment">// <span class="doctag">TODO:</span> server use user main method to generate job graph</span></span><br><span class="line">		<span class="keyword">if</span> (jobGraph != <span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				<span class="type">File</span> <span class="variable">fp</span> <span class="operator">=</span> File.createTempFile(appId.toString(), <span class="literal">null</span>);</span><br><span class="line">				fp.deleteOnExit();</span><br><span class="line">				<span class="keyword">try</span> (<span class="type">FileOutputStream</span> <span class="variable">output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(fp);</span><br><span class="line">					<span class="type">ObjectOutputStream</span> <span class="variable">obOutput</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(output);)&#123;</span><br><span class="line">					obOutput.writeObject(jobGraph);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="type">LocalResource</span> <span class="variable">jobgraph</span> <span class="operator">=</span> Records.newRecord(LocalResource.class);</span><br><span class="line">				<span class="type">Path</span> <span class="variable">remoteJobGraph</span> <span class="operator">=</span></span><br><span class="line">						Utils.setupLocalResource(fs, appId.toString(), <span class="keyword">new</span> <span class="title class_">Path</span>(fp.toURI()), jobgraph, fs.getHomeDirectory());</span><br><span class="line">				localResources.put(<span class="string">&quot;job.graph&quot;</span>, jobgraph);</span><br><span class="line">				paths.add(remoteJobGraph);</span><br><span class="line">				classPathBuilder.append(<span class="string">&quot;job.graph&quot;</span>).append(File.pathSeparator);</span><br><span class="line">			&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">				LOG.warn(<span class="string">&quot;Add job graph to local resource fail&quot;</span>);</span><br><span class="line">				<span class="keyword">throw</span> e;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="type">Path</span> <span class="variable">yarnFilesDir</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Path</span>(fs.getHomeDirectory(), <span class="string">&quot;.flink/&quot;</span> + appId + <span class="string">&#x27;/&#x27;</span>);</span><br><span class="line"></span><br><span class="line">		<span class="type">FsPermission</span> <span class="variable">permission</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FsPermission</span>(FsAction.ALL, FsAction.NONE, FsAction.NONE);</span><br><span class="line">		fs.setPermission(yarnFilesDir, permission); <span class="comment">// set permission for path.</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">//To support Yarn Secure Integration Test Scenario</span></span><br><span class="line">		<span class="comment">//In Integration test setup, the Yarn containers created by YarnMiniCluster does not have the Yarn site XML</span></span><br><span class="line">		<span class="comment">//and KRB5 configuration files. We are adding these files as container local resources for the container</span></span><br><span class="line">		<span class="comment">//applications (JM/TMs) to have proper secure cluster setup</span></span><br><span class="line">		<span class="type">Path</span> <span class="variable">remoteKrb5Path</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">		<span class="type">Path</span> <span class="variable">remoteYarnSiteXmlPath</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">		<span class="type">boolean</span> <span class="variable">hasKrb5</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">		<span class="keyword">if</span> (System.getenv(<span class="string">&quot;IN_TESTS&quot;</span>) != <span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="type">String</span> <span class="variable">krb5Config</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;java.security.krb5.conf&quot;</span>);</span><br><span class="line">			<span class="keyword">if</span> (krb5Config != <span class="literal">null</span> &amp;&amp; krb5Config.length() != <span class="number">0</span>) &#123;</span><br><span class="line">				<span class="type">File</span> <span class="variable">krb5</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(krb5Config);</span><br><span class="line">				LOG.info(<span class="string">&quot;Adding KRB5 configuration &#123;&#125; to the AM container local resource bucket&quot;</span>, krb5.getAbsolutePath());</span><br><span class="line">				<span class="type">LocalResource</span> <span class="variable">krb5ConfResource</span> <span class="operator">=</span> Records.newRecord(LocalResource.class);</span><br><span class="line">				<span class="type">Path</span> <span class="variable">krb5ConfPath</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Path</span>(krb5.getAbsolutePath());</span><br><span class="line">				remoteKrb5Path = Utils.setupLocalResource(fs, appId.toString(), krb5ConfPath, krb5ConfResource, fs.getHomeDirectory());</span><br><span class="line">				localResources.put(Utils.KRB5_FILE_NAME, krb5ConfResource);</span><br><span class="line"></span><br><span class="line">				<span class="type">File</span> <span class="variable">f</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(System.getenv(<span class="string">&quot;YARN_CONF_DIR&quot;</span>), Utils.YARN_SITE_FILE_NAME);</span><br><span class="line">				LOG.info(<span class="string">&quot;Adding Yarn configuration &#123;&#125; to the AM container local resource bucket&quot;</span>, f.getAbsolutePath());</span><br><span class="line">				<span class="type">LocalResource</span> <span class="variable">yarnConfResource</span> <span class="operator">=</span> Records.newRecord(LocalResource.class);</span><br><span class="line">				<span class="type">Path</span> <span class="variable">yarnSitePath</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Path</span>(f.getAbsolutePath());</span><br><span class="line">				remoteYarnSiteXmlPath = Utils.setupLocalResource(fs, appId.toString(), yarnSitePath, yarnConfResource, fs.getHomeDirectory());</span><br><span class="line">				localResources.put(Utils.YARN_SITE_FILE_NAME, yarnConfResource);</span><br><span class="line"></span><br><span class="line">				hasKrb5 = <span class="literal">true</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// setup security tokens</span></span><br><span class="line">		<span class="type">LocalResource</span> <span class="variable">keytabResource</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">		<span class="type">Path</span> <span class="variable">remotePathKeytab</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">		<span class="type">String</span> <span class="variable">keytab</span> <span class="operator">=</span> flinkConfiguration.getString(SecurityOptions.KERBEROS_LOGIN_KEYTAB);</span><br><span class="line">		<span class="keyword">if</span> (keytab != <span class="literal">null</span>) &#123;</span><br><span class="line">			LOG.info(<span class="string">&quot;Adding keytab &#123;&#125; to the AM container local resource bucket&quot;</span>, keytab);</span><br><span class="line">			keytabResource = Records.newRecord(LocalResource.class);</span><br><span class="line">			<span class="type">Path</span> <span class="variable">keytabPath</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Path</span>(keytab);</span><br><span class="line">			remotePathKeytab = Utils.setupLocalResource(fs, appId.toString(), keytabPath, keytabResource, fs.getHomeDirectory());</span><br><span class="line">			localResources.put(Utils.KEYTAB_FILE_NAME, keytabResource);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">final</span> <span class="type">ContainerLaunchContext</span> <span class="variable">amContainer</span> <span class="operator">=</span> setupApplicationMasterContainer(hasLogback, hasLog4j, hasKrb5);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (UserGroupInformation.isSecurityEnabled() &amp;&amp; keytab == <span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="comment">//set tokens only when keytab is not provided</span></span><br><span class="line">			LOG.info(<span class="string">&quot;Adding delegation token to the AM container..&quot;</span>);</span><br><span class="line">			Utils.setTokensFor(amContainer, paths, conf);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		amContainer.setLocalResources(localResources);</span><br><span class="line">		fs.close();</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Setup CLASSPATH and environment variables for ApplicationMaster</span></span><br><span class="line">		<span class="keyword">final</span> Map&lt;String, String&gt; appMasterEnv = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">		<span class="comment">// set user specified app master environment variables</span></span><br><span class="line">		appMasterEnv.putAll(Utils.getEnvironmentVariables(ConfigConstants.YARN_APPLICATION_MASTER_ENV_PREFIX, flinkConfiguration));</span><br><span class="line">		<span class="comment">// set Flink app class path</span></span><br><span class="line">		appMasterEnv.put(YarnConfigKeys.ENV_FLINK_CLASSPATH, classPathBuilder.toString());</span><br><span class="line"></span><br><span class="line">		<span class="comment">// set Flink on YARN internal configuration values</span></span><br><span class="line">		appMasterEnv.put(YarnConfigKeys.ENV_TM_COUNT, String.valueOf(taskManagerCount));</span><br><span class="line">		appMasterEnv.put(YarnConfigKeys.ENV_TM_MEMORY, String.valueOf(taskManagerMemoryMb));</span><br><span class="line">		appMasterEnv.put(YarnConfigKeys.FLINK_JAR_PATH, remotePathJar.toString());</span><br><span class="line">		appMasterEnv.put(YarnConfigKeys.ENV_APP_ID, appId.toString());</span><br><span class="line">		appMasterEnv.put(YarnConfigKeys.ENV_CLIENT_HOME_DIR, fs.getHomeDirectory().toString());</span><br><span class="line">		appMasterEnv.put(YarnConfigKeys.ENV_CLIENT_SHIP_FILES, envShipFileList.toString());</span><br><span class="line">		appMasterEnv.put(YarnConfigKeys.ENV_SLOTS, String.valueOf(slots));</span><br><span class="line">		appMasterEnv.put(YarnConfigKeys.ENV_DETACHED, String.valueOf(detached));</span><br><span class="line">		appMasterEnv.put(YarnConfigKeys.ENV_ZOOKEEPER_NAMESPACE, getZookeeperNamespace());</span><br><span class="line">		appMasterEnv.put(YarnConfigKeys.FLINK_YARN_FILES, yarnFilesDir.toUri().toString());</span><br><span class="line"></span><br><span class="line">		<span class="comment">// https://github.com/apache/hadoop/blob/trunk/hadoop-yarn-project/hadoop-yarn/hadoop-yarn-site/src/site/markdown/YarnApplicationSecurity.md#identity-on-an-insecure-cluster-hadoop_user_name</span></span><br><span class="line">		appMasterEnv.put(YarnConfigKeys.ENV_HADOOP_USER_NAME, UserGroupInformation.getCurrentUser().getUserName());</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (keytabResource != <span class="literal">null</span>) &#123;</span><br><span class="line">			appMasterEnv.put(YarnConfigKeys.KEYTAB_PATH, remotePathKeytab.toString());</span><br><span class="line">			<span class="type">String</span> <span class="variable">principal</span> <span class="operator">=</span> flinkConfiguration.getString(SecurityOptions.KERBEROS_LOGIN_PRINCIPAL);</span><br><span class="line">			appMasterEnv.put(YarnConfigKeys.KEYTAB_PRINCIPAL, principal);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//To support Yarn Secure Integration Test Scenario</span></span><br><span class="line">		<span class="keyword">if</span> (remoteYarnSiteXmlPath != <span class="literal">null</span> &amp;&amp; remoteKrb5Path != <span class="literal">null</span>) &#123;</span><br><span class="line">			appMasterEnv.put(YarnConfigKeys.ENV_YARN_SITE_XML_PATH, remoteYarnSiteXmlPath.toString());</span><br><span class="line">			appMasterEnv.put(YarnConfigKeys.ENV_KRB5_PATH, remoteKrb5Path.toString());</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (dynamicPropertiesEncoded != <span class="literal">null</span>) &#123;</span><br><span class="line">			appMasterEnv.put(YarnConfigKeys.ENV_DYNAMIC_PROPERTIES, dynamicPropertiesEncoded);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// set classpath from YARN configuration</span></span><br><span class="line">		Utils.setupYarnClassPath(conf, appMasterEnv);</span><br><span class="line"></span><br><span class="line">		amContainer.setEnvironment(appMasterEnv);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Set up resource type requirements for ApplicationMaster</span></span><br><span class="line">		<span class="type">Resource</span> <span class="variable">capability</span> <span class="operator">=</span> Records.newRecord(Resource.class);</span><br><span class="line">		capability.setMemory(jobManagerMemoryMb);</span><br><span class="line">		capability.setVirtualCores(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">		String name;</span><br><span class="line">		<span class="keyword">if</span> (customName == <span class="literal">null</span>) &#123;</span><br><span class="line">			name = <span class="string">&quot;Flink session with &quot;</span> + taskManagerCount + <span class="string">&quot; TaskManagers&quot;</span>;</span><br><span class="line">			<span class="keyword">if</span> (detached) &#123;</span><br><span class="line">				name += <span class="string">&quot; (detached)&quot;</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			name = customName;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		appContext.setApplicationName(name);</span><br><span class="line">		appContext.setApplicationType(<span class="string">&quot;Apache Flink&quot;</span>);</span><br><span class="line">		appContext.setAMContainerSpec(amContainer);</span><br><span class="line">		appContext.setResource(capability);</span><br><span class="line">		<span class="keyword">if</span> (yarnQueue != <span class="literal">null</span>) &#123;</span><br><span class="line">			appContext.setQueue(yarnQueue);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		setApplicationTags(appContext);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// add a hook to clean up in case deployment fails</span></span><br><span class="line">		<span class="type">Thread</span> <span class="variable">deploymentFailureHook</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DeploymentFailureHook</span>(yarnClient, yarnApplication, yarnFilesDir);</span><br><span class="line">		Runtime.getRuntime().addShutdownHook(deploymentFailureHook);</span><br><span class="line">		LOG.info(<span class="string">&quot;Submitting application master &quot;</span> + appId);</span><br><span class="line">		yarnClient.submitApplication(appContext);</span><br><span class="line"></span><br><span class="line">		LOG.info(<span class="string">&quot;Waiting for the cluster to be allocated&quot;</span>);</span><br><span class="line">		<span class="keyword">final</span> <span class="type">long</span> <span class="variable">startTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">		ApplicationReport report;</span><br><span class="line">		<span class="type">YarnApplicationState</span> <span class="variable">lastAppState</span> <span class="operator">=</span> YarnApplicationState.NEW;</span><br><span class="line">		loop: <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				report = yarnClient.getApplicationReport(appId);</span><br><span class="line">			&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">YarnDeploymentException</span>(<span class="string">&quot;Failed to deploy the cluster.&quot;</span>, e);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="type">YarnApplicationState</span> <span class="variable">appState</span> <span class="operator">=</span> report.getYarnApplicationState();</span><br><span class="line">			LOG.debug(<span class="string">&quot;Application State: &#123;&#125;&quot;</span>, appState);</span><br><span class="line">			<span class="keyword">switch</span>(appState) &#123;</span><br><span class="line">				<span class="keyword">case</span> FAILED:</span><br><span class="line">				<span class="keyword">case</span> FINISHED: <span class="comment">//<span class="doctag">TODO:</span> the finished state may be valid in flip-6</span></span><br><span class="line">				<span class="keyword">case</span> KILLED:</span><br><span class="line">					<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">YarnDeploymentException</span>(<span class="string">&quot;The YARN application unexpectedly switched to state &quot;</span></span><br><span class="line">						+ appState + <span class="string">&quot; during deployment. \n&quot;</span> +</span><br><span class="line">						<span class="string">&quot;Diagnostics from YARN: &quot;</span> + report.getDiagnostics() + <span class="string">&quot;\n&quot;</span> +</span><br><span class="line">						<span class="string">&quot;If log aggregation is enabled on your cluster, use this command to further investigate the issue:\n&quot;</span> +</span><br><span class="line">						<span class="string">&quot;yarn logs -applicationId &quot;</span> + appId);</span><br><span class="line">					<span class="comment">//break ..</span></span><br><span class="line">				<span class="keyword">case</span> RUNNING:</span><br><span class="line">					LOG.info(<span class="string">&quot;YARN application has been deployed successfully.&quot;</span>);</span><br><span class="line">					<span class="keyword">break</span> loop;</span><br><span class="line">				<span class="keyword">default</span>:</span><br><span class="line">					<span class="keyword">if</span> (appState != lastAppState) &#123;</span><br><span class="line">						LOG.info(<span class="string">&quot;Deploying cluster, current state &quot;</span> + appState);</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">if</span> (System.currentTimeMillis() - startTime &gt; <span class="number">60000</span>) &#123;</span><br><span class="line">						LOG.info(<span class="string">&quot;Deployment took more than 60 seconds. Please check if the requested resources are available in the YARN cluster&quot;</span>);</span><br><span class="line">					&#125;</span><br><span class="line"></span><br><span class="line">			&#125;</span><br><span class="line">			lastAppState = appState;</span><br><span class="line">			Thread.sleep(<span class="number">250</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// print the application id for user to cancel themselves.</span></span><br><span class="line">		<span class="keyword">if</span> (isDetachedMode()) &#123;</span><br><span class="line">			LOG.info(<span class="string">&quot;The Flink YARN client has been started in detached mode. In order to stop &quot;</span> +</span><br><span class="line">					<span class="string">&quot;Flink on YARN, use the following command or a YARN web interface to stop &quot;</span> +</span><br><span class="line">					<span class="string">&quot;it:\nyarn application -kill &quot;</span> + appId + <span class="string">&quot;\nPlease also note that the &quot;</span> +</span><br><span class="line">					<span class="string">&quot;temporary files of the YARN session in the home directoy will not be removed.&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// since deployment was successful, remove the hook</span></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			Runtime.getRuntime().removeShutdownHook(deploymentFailureHook);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IllegalStateException e) &#123;</span><br><span class="line">			<span class="comment">// we&#x27;re already in the shut down hook.</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> report;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>这个函数很长，下面依次分析一下它都做了什么：</p>
<ul>
<li>初始化要使用的文件系统</li>
<li>获得yarnApplication的ApplicationSubmissionContext类的实例appContext</li>
<li>添加需要传输的文件，附加上log的配置文件、lib目录</li>
<li>通过zkNamespace来配置高可用</li>
<li>整理classpath</li>
<li>把jar,配置文件，jobGraph，认证信息放入到localResources中</li>
<li>通过setupApplicationMasterContainer函数来创建am启动需要的ContainerLaunchContext类的amContainer实例。这个函数里面指定了am启动时的很多重要参数，比如主类：YarnApplicationMasterRunner等。</li>
<li>设置am启动需要的Env，包括：<ul>
<li>_CLIENT_TM_MEMORY</li>
<li>_CLIENT_TM_COUNT</li>
<li>_APP_ID</li>
<li>_CLIENT_HOME_DIR</li>
<li>_CLIENT_SHIP_FILES</li>
<li>_SLOTS</li>
<li>_DETACHED</li>
<li>_DYNAMIC_PROPERTIES</li>
<li>_FLINK_CLASSPATH</li>
<li>_FLINK_JAR_PATH</li>
<li>_FLINK_YARN_FILES</li>
<li>_KEYTAB_PATH</li>
<li>_KEYTAB_PRINCIPAL</li>
<li>HADOOP_USER_NAME</li>
<li>_ZOOKEEPER_NAMESPACE</li>
<li>_KRB5_PATH</li>
<li>_YARN_SITE_XML_PATH</li>
</ul>
</li>
<li>设置appContext的appname,type,amcontainer信息，am资源，队列，ApplicationTags</li>
<li>设置一个失败处理的回调函数(主要是清理现场)deploymentFailureHook</li>
<li>调用yarnClient.submitApplication(appContext)提交应用。<strong>这里就是正式的把am提交给yarn去执行了</strong>。</li>
<li>循环等待来获取刚刚提交的am任务的状态，直到取得RUNNING</li>
<li>删除掉之前注册的失败处理的回调函数</li>
<li>返回通过yarnClient.getApplicationReport(appId)获得的report</li>
</ul>
<h1 id="4-YarnApplicationMasterRunner"><a href="#4-YarnApplicationMasterRunner" class="headerlink" title="4. YarnApplicationMasterRunner"></a>4. YarnApplicationMasterRunner</h1><p>经过上面的流程，会在YARN中启动一个container，用来运行appmaster，这个appmaster启动之后，会跟RM和NM交互申请资源，并且管理Flinkjob的运行。下面进入AppMaster的源码分析，首先是它的main函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//位置：flink/flink-yarn/src/main/java/org/apache/flink/yarn/YarnApplicationMasterRunner.java</span></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * The entry point for the YARN application master.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> args The command line arguments.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">		EnvironmentInformation.logEnvironmentInfo(LOG, <span class="string">&quot;YARN ApplicationMaster / ResourceManager / JobManager&quot;</span>, args);</span><br><span class="line">		SignalHandler.register(LOG);</span><br><span class="line">		JvmShutdownSafeguard.installAsShutdownHook(LOG);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// run and exit with the proper return code</span></span><br><span class="line">		<span class="type">int</span> <span class="variable">returnCode</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">YarnApplicationMasterRunner</span>().run(args);</span><br><span class="line">		System.exit(returnCode);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>首先是打印一些提示日志，然后注册一个失败时的清理钩子，最后是调用了YarnApplicationMasterRunner().run(args)方法，下面继续跟进：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//位置：flink/flink-yarn/src/main/java/org/apache/flink/yarn/YarnApplicationMasterRunner.java</span></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * The instance entry point for the YARN application master. Obtains user group</span></span><br><span class="line"><span class="comment">	 * information and calls the main work method &#123;<span class="doctag">@link</span> #runApplicationMaster(Configuration)&#125; as a</span></span><br><span class="line"><span class="comment">	 * privileged action.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> args The command line arguments.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> The process exit code.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">protected</span> <span class="type">int</span> <span class="title function_">run</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			LOG.debug(<span class="string">&quot;All environment variables: &#123;&#125;&quot;</span>, ENV);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">final</span> <span class="type">String</span> <span class="variable">yarnClientUsername</span> <span class="operator">=</span> ENV.get(YarnConfigKeys.ENV_HADOOP_USER_NAME);</span><br><span class="line">			require(yarnClientUsername != <span class="literal">null</span>, <span class="string">&quot;YARN client user name environment variable &#123;&#125; not set&quot;</span>,</span><br><span class="line">				YarnConfigKeys.ENV_HADOOP_USER_NAME);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">final</span> <span class="type">String</span> <span class="variable">currDir</span> <span class="operator">=</span> ENV.get(Environment.PWD.key());</span><br><span class="line">			require(currDir != <span class="literal">null</span>, <span class="string">&quot;Current working directory variable (%s) not set&quot;</span>, Environment.PWD.key());</span><br><span class="line">			LOG.debug(<span class="string">&quot;Current working Directory: &#123;&#125;&quot;</span>, currDir);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">final</span> <span class="type">String</span> <span class="variable">remoteKeytabPath</span> <span class="operator">=</span> ENV.get(YarnConfigKeys.KEYTAB_PATH);</span><br><span class="line">			LOG.debug(<span class="string">&quot;remoteKeytabPath obtained &#123;&#125;&quot;</span>, remoteKeytabPath);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">final</span> <span class="type">String</span> <span class="variable">remoteKeytabPrincipal</span> <span class="operator">=</span> ENV.get(YarnConfigKeys.KEYTAB_PRINCIPAL);</span><br><span class="line">			LOG.info(<span class="string">&quot;remoteKeytabPrincipal obtained &#123;&#125;&quot;</span>, remoteKeytabPrincipal);</span><br><span class="line"></span><br><span class="line">			<span class="type">String</span> <span class="variable">keytabPath</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">			<span class="keyword">if</span> (remoteKeytabPath != <span class="literal">null</span>) &#123;</span><br><span class="line">				<span class="type">File</span> <span class="variable">f</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(currDir, Utils.KEYTAB_FILE_NAME);</span><br><span class="line">				keytabPath = f.getAbsolutePath();</span><br><span class="line">				LOG.debug(<span class="string">&quot;keytabPath: &#123;&#125;&quot;</span>, keytabPath);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="type">UserGroupInformation</span> <span class="variable">currentUser</span> <span class="operator">=</span> UserGroupInformation.getCurrentUser();</span><br><span class="line"></span><br><span class="line">			LOG.info(<span class="string">&quot;YARN daemon is running as: &#123;&#125; Yarn client user obtainer: &#123;&#125;&quot;</span>,</span><br><span class="line">					currentUser.getShortUserName(), yarnClientUsername);</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Flink configuration</span></span><br><span class="line">			<span class="keyword">final</span> Map&lt;String, String&gt; dynamicProperties =</span><br><span class="line">				FlinkYarnSessionCli.getDynamicProperties(ENV.get(YarnConfigKeys.ENV_DYNAMIC_PROPERTIES));</span><br><span class="line">			LOG.debug(<span class="string">&quot;YARN dynamic properties: &#123;&#125;&quot;</span>, dynamicProperties);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">final</span> <span class="type">Configuration</span> <span class="variable">flinkConfig</span> <span class="operator">=</span> createConfiguration(currDir, dynamicProperties);</span><br><span class="line"></span><br><span class="line">			<span class="comment">// set keytab principal and replace path with the local path of the shipped keytab file in NodeManager</span></span><br><span class="line">			<span class="keyword">if</span> (keytabPath != <span class="literal">null</span> &amp;&amp; remoteKeytabPrincipal != <span class="literal">null</span>) &#123;</span><br><span class="line">				flinkConfig.setString(SecurityOptions.KERBEROS_LOGIN_KEYTAB, keytabPath);</span><br><span class="line">				flinkConfig.setString(SecurityOptions.KERBEROS_LOGIN_PRINCIPAL, remoteKeytabPrincipal);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			org.apache.hadoop.conf.<span class="type">Configuration</span> <span class="variable">hadoopConfiguration</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">			<span class="comment">//To support Yarn Secure Integration Test Scenario</span></span><br><span class="line">			<span class="type">File</span> <span class="variable">krb5Conf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(currDir, Utils.KRB5_FILE_NAME);</span><br><span class="line">			<span class="keyword">if</span> (krb5Conf.exists() &amp;&amp; krb5Conf.canRead()) &#123;</span><br><span class="line">				<span class="type">String</span> <span class="variable">krb5Path</span> <span class="operator">=</span> krb5Conf.getAbsolutePath();</span><br><span class="line">				LOG.info(<span class="string">&quot;KRB5 Conf: &#123;&#125;&quot;</span>, krb5Path);</span><br><span class="line">				hadoopConfiguration = <span class="keyword">new</span> <span class="title class_">org</span>.apache.hadoop.conf.Configuration();</span><br><span class="line">				hadoopConfiguration.set(CommonConfigurationKeysPublic.HADOOP_SECURITY_AUTHENTICATION, <span class="string">&quot;kerberos&quot;</span>);</span><br><span class="line">				hadoopConfiguration.set(CommonConfigurationKeysPublic.HADOOP_SECURITY_AUTHORIZATION, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			SecurityUtils.SecurityConfiguration sc;</span><br><span class="line">			<span class="keyword">if</span> (hadoopConfiguration != <span class="literal">null</span>) &#123;</span><br><span class="line">				sc = <span class="keyword">new</span> <span class="title class_">SecurityUtils</span>.SecurityConfiguration(flinkConfig, hadoopConfiguration);</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				sc = <span class="keyword">new</span> <span class="title class_">SecurityUtils</span>.SecurityConfiguration(flinkConfig);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			SecurityUtils.install(sc);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">return</span> SecurityUtils.getInstalledContext().runSecured(<span class="keyword">new</span> <span class="title class_">Callable</span>&lt;Integer&gt;() &#123;</span><br><span class="line">				<span class="meta">@Override</span></span><br><span class="line">				<span class="keyword">public</span> Integer <span class="title function_">call</span><span class="params">()</span> &#123;</span><br><span class="line">					<span class="keyword">return</span> runApplicationMaster(flinkConfig);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;);</span><br><span class="line"></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">			<span class="comment">// make sure that everything whatever ends up in the log</span></span><br><span class="line">			LOG.error(<span class="string">&quot;YARN Application Master initialization failed&quot;</span>, t);</span><br><span class="line">			<span class="keyword">return</span> INIT_ERROR_EXIT_CODE;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>这个函数主要是在做参数检测，最后通过runSecured方法，调用启动了一个线程，用来执行runApplicationMaster(flinkConfig)，这个方法是appmaster所有逻辑中最核心的部分，源码也比较长，下面继续跟进：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//位置：flink/flink-yarn/src/main/java/org/apache/flink/yarn/YarnApplicationMasterRunner.java</span></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * The main work method, must run as a privileged action.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> The return code for the Java process.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">protected</span> <span class="type">int</span> <span class="title function_">runApplicationMaster</span><span class="params">(Configuration config)</span> &#123;</span><br><span class="line">		<span class="type">ActorSystem</span> <span class="variable">actorSystem</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">		<span class="type">WebMonitor</span> <span class="variable">webMonitor</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">		<span class="type">HighAvailabilityServices</span> <span class="variable">highAvailabilityServices</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">		<span class="type">int</span> <span class="variable">numberProcessors</span> <span class="operator">=</span> Hardware.getNumberCPUCores();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">final</span> <span class="type">ScheduledExecutorService</span> <span class="variable">futureExecutor</span> <span class="operator">=</span> Executors.newScheduledThreadPool(</span><br><span class="line">			numberProcessors,</span><br><span class="line">			<span class="keyword">new</span> <span class="title class_">ExecutorThreadFactory</span>(<span class="string">&quot;yarn-jobmanager-future&quot;</span>));</span><br><span class="line"></span><br><span class="line">		<span class="keyword">final</span> <span class="type">ExecutorService</span> <span class="variable">ioExecutor</span> <span class="operator">=</span> Executors.newFixedThreadPool(</span><br><span class="line">			numberProcessors,</span><br><span class="line">			<span class="keyword">new</span> <span class="title class_">ExecutorThreadFactory</span>(<span class="string">&quot;yarn-jobmanager-io&quot;</span>));</span><br><span class="line"></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="comment">// ------- (1) load and parse / validate all configurations -------</span></span><br><span class="line"></span><br><span class="line">			<span class="comment">// loading all config values here has the advantage that the program fails fast, if any</span></span><br><span class="line">			<span class="comment">// configuration problem occurs</span></span><br><span class="line"></span><br><span class="line">			<span class="keyword">final</span> <span class="type">String</span> <span class="variable">currDir</span> <span class="operator">=</span> ENV.get(Environment.PWD.key());</span><br><span class="line">			require(currDir != <span class="literal">null</span>, <span class="string">&quot;Current working directory variable (%s) not set&quot;</span>, Environment.PWD.key());</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Note that we use the &quot;appMasterHostname&quot; given by YARN here, to make sure</span></span><br><span class="line">			<span class="comment">// we use the hostnames given by YARN consistently throughout akka.</span></span><br><span class="line">			<span class="comment">// for akka &quot;localhost&quot; and &quot;localhost.localdomain&quot; are different actors.</span></span><br><span class="line">			<span class="keyword">final</span> <span class="type">String</span> <span class="variable">appMasterHostname</span> <span class="operator">=</span> ENV.get(Environment.NM_HOST.key());</span><br><span class="line">			require(appMasterHostname != <span class="literal">null</span>,</span><br><span class="line">				<span class="string">&quot;ApplicationMaster hostname variable %s not set&quot;</span>, Environment.NM_HOST.key());</span><br><span class="line"></span><br><span class="line">			LOG.info(<span class="string">&quot;YARN assigned hostname for application master: &#123;&#125;&quot;</span>, appMasterHostname);</span><br><span class="line"></span><br><span class="line">			<span class="comment">//Update keytab and principal path to reflect YARN container path location</span></span><br><span class="line">			<span class="keyword">final</span> <span class="type">String</span> <span class="variable">remoteKeytabPath</span> <span class="operator">=</span> ENV.get(YarnConfigKeys.KEYTAB_PATH);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">final</span> <span class="type">String</span> <span class="variable">remoteKeytabPrincipal</span> <span class="operator">=</span> ENV.get(YarnConfigKeys.KEYTAB_PRINCIPAL);</span><br><span class="line"></span><br><span class="line">			<span class="type">String</span> <span class="variable">keytabPath</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">			<span class="keyword">if</span> (remoteKeytabPath != <span class="literal">null</span>) &#123;</span><br><span class="line">				<span class="type">File</span> <span class="variable">f</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(currDir, Utils.KEYTAB_FILE_NAME);</span><br><span class="line">				keytabPath = f.getAbsolutePath();</span><br><span class="line">				LOG.info(<span class="string">&quot;keytabPath: &#123;&#125;&quot;</span>, keytabPath);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (keytabPath != <span class="literal">null</span> &amp;&amp; remoteKeytabPrincipal != <span class="literal">null</span>) &#123;</span><br><span class="line">				config.setString(SecurityOptions.KERBEROS_LOGIN_KEYTAB, keytabPath);</span><br><span class="line">				config.setString(SecurityOptions.KERBEROS_LOGIN_PRINCIPAL, remoteKeytabPrincipal);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Hadoop/Yarn configuration (loads config data automatically from classpath files)</span></span><br><span class="line">			<span class="keyword">final</span> <span class="type">YarnConfiguration</span> <span class="variable">yarnConfig</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">YarnConfiguration</span>();</span><br><span class="line"></span><br><span class="line">			<span class="keyword">final</span> <span class="type">int</span> taskManagerContainerMemory;</span><br><span class="line">			<span class="keyword">final</span> <span class="type">int</span> numInitialTaskManagers;</span><br><span class="line">			<span class="keyword">final</span> <span class="type">int</span> slotsPerTaskManager;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				taskManagerContainerMemory = Integer.parseInt(ENV.get(YarnConfigKeys.ENV_TM_MEMORY));</span><br><span class="line">			&#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Invalid value for &quot;</span> + YarnConfigKeys.ENV_TM_MEMORY + <span class="string">&quot; : &quot;</span></span><br><span class="line">					+ e.getMessage());</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				numInitialTaskManagers = Integer.parseInt(ENV.get(YarnConfigKeys.ENV_TM_COUNT));</span><br><span class="line">			&#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Invalid value for &quot;</span> + YarnConfigKeys.ENV_TM_COUNT + <span class="string">&quot; : &quot;</span></span><br><span class="line">					+ e.getMessage());</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				slotsPerTaskManager = Integer.parseInt(ENV.get(YarnConfigKeys.ENV_SLOTS));</span><br><span class="line">			&#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Invalid value for &quot;</span> + YarnConfigKeys.ENV_SLOTS + <span class="string">&quot; : &quot;</span></span><br><span class="line">					+ e.getMessage());</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">final</span> <span class="type">ContaineredTaskManagerParameters</span> <span class="variable">taskManagerParameters</span> <span class="operator">=</span></span><br><span class="line">				ContaineredTaskManagerParameters.create(config, taskManagerContainerMemory, slotsPerTaskManager);</span><br><span class="line"></span><br><span class="line">			LOG.info(<span class="string">&quot;TaskManagers will be created with &#123;&#125; task slots&quot;</span>, taskManagerParameters.numSlots());</span><br><span class="line">			LOG.info(<span class="string">&quot;TaskManagers will be started with container size &#123;&#125; MB, JVM heap size &#123;&#125; MB, &quot;</span> +</span><br><span class="line">				<span class="string">&quot;JVM direct memory limit &#123;&#125; MB&quot;</span>,</span><br><span class="line">				taskManagerParameters.taskManagerTotalMemoryMB(),</span><br><span class="line">				taskManagerParameters.taskManagerHeapSizeMB(),</span><br><span class="line">				taskManagerParameters.taskManagerDirectMemoryLimitMB());</span><br><span class="line"></span><br><span class="line">			<span class="comment">// ----------------- (2) start the actor system -------------------</span></span><br><span class="line"></span><br><span class="line">			<span class="comment">// try to start the actor system, JobManager and JobManager actor system</span></span><br><span class="line">			<span class="comment">// using the port range definition from the config.</span></span><br><span class="line">			<span class="keyword">final</span> <span class="type">String</span> <span class="variable">amPortRange</span> <span class="operator">=</span> config.getString(</span><br><span class="line">					ConfigConstants.YARN_APPLICATION_MASTER_PORT,</span><br><span class="line">					ConfigConstants.DEFAULT_YARN_JOB_MANAGER_PORT);</span><br><span class="line"></span><br><span class="line">			actorSystem = BootstrapTools.startActorSystem(config, appMasterHostname, amPortRange, LOG);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">final</span> <span class="type">String</span> <span class="variable">akkaHostname</span> <span class="operator">=</span> AkkaUtils.getAddress(actorSystem).host().get();</span><br><span class="line">			<span class="keyword">final</span> <span class="type">int</span> <span class="variable">akkaPort</span> <span class="operator">=</span> (Integer) AkkaUtils.getAddress(actorSystem).port().get();</span><br><span class="line"></span><br><span class="line">			LOG.info(<span class="string">&quot;Actor system bound to hostname &#123;&#125;.&quot;</span>, akkaHostname);</span><br><span class="line"></span><br><span class="line">			<span class="comment">// ---- (3) Generate the configuration for the TaskManagers</span></span><br><span class="line"></span><br><span class="line">			<span class="keyword">final</span> <span class="type">Configuration</span> <span class="variable">taskManagerConfig</span> <span class="operator">=</span> BootstrapTools.generateTaskManagerConfiguration(</span><br><span class="line">					config, akkaHostname, akkaPort, slotsPerTaskManager, TASKMANAGER_REGISTRATION_TIMEOUT);</span><br><span class="line">			LOG.debug(<span class="string">&quot;TaskManager configuration: &#123;&#125;&quot;</span>, taskManagerConfig);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">final</span> <span class="type">ContainerLaunchContext</span> <span class="variable">taskManagerContext</span> <span class="operator">=</span> Utils.createTaskExecutorContext(</span><br><span class="line">				config, yarnConfig, ENV,</span><br><span class="line">				taskManagerParameters, taskManagerConfig,</span><br><span class="line">				currDir, getTaskManagerClass(), LOG);</span><br><span class="line"></span><br><span class="line">			<span class="comment">// ---- (4) start the actors and components in this order:</span></span><br><span class="line"></span><br><span class="line">			<span class="comment">// 1) JobManager &amp; Archive (in non-HA case, the leader service takes this)</span></span><br><span class="line">			<span class="comment">// 2) Web Monitor (we need its port to register)</span></span><br><span class="line">			<span class="comment">// 3) Resource Master for YARN</span></span><br><span class="line">			<span class="comment">// 4) Process reapers for the JobManager and Resource Master</span></span><br><span class="line"></span><br><span class="line">			<span class="comment">// 0: Start the JobManager services</span></span><br><span class="line"></span><br><span class="line">			<span class="comment">// update the configuration used to create the high availability services</span></span><br><span class="line">			config.setString(JobManagerOptions.ADDRESS, akkaHostname);</span><br><span class="line">			config.setInteger(JobManagerOptions.PORT, akkaPort);</span><br><span class="line"></span><br><span class="line">			highAvailabilityServices = HighAvailabilityServicesUtils.createHighAvailabilityServices(</span><br><span class="line">				config,</span><br><span class="line">				ioExecutor,</span><br><span class="line">				HighAvailabilityServicesUtils.AddressResolution.NO_ADDRESS_RESOLUTION);</span><br><span class="line"></span><br><span class="line">			<span class="comment">// 1: the JobManager</span></span><br><span class="line">			LOG.debug(<span class="string">&quot;Starting JobManager actor&quot;</span>);</span><br><span class="line"></span><br><span class="line">			<span class="comment">// we start the JobManager with its standard name</span></span><br><span class="line">			<span class="type">ActorRef</span> <span class="variable">jobManager</span> <span class="operator">=</span> JobManager.startJobManagerActors(</span><br><span class="line">				config,</span><br><span class="line">				actorSystem,</span><br><span class="line">				futureExecutor,</span><br><span class="line">				ioExecutor,</span><br><span class="line">				highAvailabilityServices,</span><br><span class="line">				<span class="keyword">new</span> <span class="title class_">Some</span>&lt;&gt;(JobMaster.JOB_MANAGER_NAME),</span><br><span class="line">				Option.&lt;String&gt;empty(),</span><br><span class="line">				getJobManagerClass(),</span><br><span class="line">				getArchivistClass())._1();</span><br><span class="line"></span><br><span class="line">			<span class="comment">// 2: the web monitor</span></span><br><span class="line">			LOG.debug(<span class="string">&quot;Starting Web Frontend&quot;</span>);</span><br><span class="line"></span><br><span class="line">			webMonitor = BootstrapTools.startWebMonitorIfConfigured(</span><br><span class="line">				config,</span><br><span class="line">				highAvailabilityServices,</span><br><span class="line">				actorSystem,</span><br><span class="line">				jobManager,</span><br><span class="line">				LOG);</span><br><span class="line"></span><br><span class="line">			<span class="type">String</span> <span class="variable">protocol</span> <span class="operator">=</span> <span class="string">&quot;http://&quot;</span>;</span><br><span class="line">			<span class="keyword">if</span> (config.getBoolean(JobManagerOptions.WEB_SSL_ENABLED) &amp;&amp; SSLUtils.getSSLEnabled(config)) &#123;</span><br><span class="line">				protocol = <span class="string">&quot;https://&quot;</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">final</span> <span class="type">String</span> <span class="variable">webMonitorURL</span> <span class="operator">=</span> webMonitor == <span class="literal">null</span> ? <span class="literal">null</span> :</span><br><span class="line">				protocol + appMasterHostname + <span class="string">&quot;:&quot;</span> + webMonitor.getServerPort();</span><br><span class="line"></span><br><span class="line">			<span class="comment">// 3: Flink&#x27;s Yarn ResourceManager</span></span><br><span class="line">			LOG.debug(<span class="string">&quot;Starting YARN Flink Resource Manager&quot;</span>);</span><br><span class="line"></span><br><span class="line">			<span class="type">Props</span> <span class="variable">resourceMasterProps</span> <span class="operator">=</span> YarnFlinkResourceManager.createActorProps(</span><br><span class="line">				getResourceManagerClass(),</span><br><span class="line">				config,</span><br><span class="line">				yarnConfig,</span><br><span class="line">				highAvailabilityServices.getJobManagerLeaderRetriever(HighAvailabilityServices.DEFAULT_JOB_ID),</span><br><span class="line">				appMasterHostname,</span><br><span class="line">				webMonitorURL,</span><br><span class="line">				taskManagerParameters,</span><br><span class="line">				taskManagerContext,</span><br><span class="line">				numInitialTaskManagers,</span><br><span class="line">				LOG);</span><br><span class="line"></span><br><span class="line">			<span class="type">ActorRef</span> <span class="variable">resourceMaster</span> <span class="operator">=</span> actorSystem.actorOf(resourceMasterProps);</span><br><span class="line"></span><br><span class="line">			<span class="comment">// 4: Process reapers</span></span><br><span class="line">			<span class="comment">// The process reapers ensure that upon unexpected actor death, the process exits</span></span><br><span class="line">			<span class="comment">// and does not stay lingering around unresponsive</span></span><br><span class="line"></span><br><span class="line">			LOG.debug(<span class="string">&quot;Starting process reapers for JobManager and YARN Application Master&quot;</span>);</span><br><span class="line"></span><br><span class="line">			actorSystem.actorOf(</span><br><span class="line">				Props.create(ProcessReaper.class, resourceMaster, LOG, ACTOR_DIED_EXIT_CODE),</span><br><span class="line">				<span class="string">&quot;YARN_Resource_Master_Process_Reaper&quot;</span>);</span><br><span class="line"></span><br><span class="line">			actorSystem.actorOf(</span><br><span class="line">				Props.create(ProcessReaper.class, jobManager, LOG, ACTOR_DIED_EXIT_CODE),</span><br><span class="line">				<span class="string">&quot;JobManager_Process_Reaper&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">			<span class="comment">// make sure that everything whatever ends up in the log</span></span><br><span class="line">			LOG.error(<span class="string">&quot;YARN Application Master initialization failed&quot;</span>, t);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (webMonitor != <span class="literal">null</span>) &#123;</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					webMonitor.stop();</span><br><span class="line">				&#125; <span class="keyword">catch</span> (Throwable ignored) &#123;</span><br><span class="line">					LOG.warn(<span class="string">&quot;Failed to stop the web frontend&quot;</span>, t);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (actorSystem != <span class="literal">null</span>) &#123;</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					actorSystem.shutdown();</span><br><span class="line">				&#125; <span class="keyword">catch</span> (Throwable tt) &#123;</span><br><span class="line">					LOG.error(<span class="string">&quot;Error shutting down actor system&quot;</span>, tt);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			futureExecutor.shutdownNow();</span><br><span class="line">			ioExecutor.shutdownNow();</span><br><span class="line"></span><br><span class="line">			<span class="keyword">return</span> INIT_ERROR_EXIT_CODE;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// everything started, we can wait until all is done or the process is killed</span></span><br><span class="line">		LOG.info(<span class="string">&quot;YARN Application Master started&quot;</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// wait until everything is done</span></span><br><span class="line">		actorSystem.awaitTermination();</span><br><span class="line"></span><br><span class="line">		<span class="comment">// if we get here, everything work out jolly all right, and we even exited smoothly</span></span><br><span class="line">		<span class="keyword">if</span> (webMonitor != <span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				webMonitor.stop();</span><br><span class="line">			&#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">				LOG.error(<span class="string">&quot;Failed to stop the web frontend&quot;</span>, t);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (highAvailabilityServices != <span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				highAvailabilityServices.close();</span><br><span class="line">			&#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">				LOG.error(<span class="string">&quot;Failed to stop the high availability services.&quot;</span>, t);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		org.apache.flink.runtime.concurrent.Executors.gracefulShutdown(</span><br><span class="line">			AkkaUtils.getTimeout(config).toMillis(),</span><br><span class="line">			TimeUnit.MILLISECONDS,</span><br><span class="line">			futureExecutor,</span><br><span class="line">			ioExecutor);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>下面一一分析这段源码中的处理逻辑：</p>
<ul>
<li>首先是校验一下各项配置是否正常，包括工作目录、主机名、keytab位置、taskmanager的配置信息</li>
<li>然后启动actor system</li>
<li>通过调用Utils.createTaskExecutorContext方法为taskmanager生成启动信息taskManagerContext</li>
<li>启动actors和components<ul>
<li>首先启动actor:jobmanager。它是JobManager类的实例。</li>
<li>然后启动web服务，用来展示界面，并把服务地址告知接下来要启动的YarnFlinkResourceManager</li>
<li>然后启动actor:resourceMaster。它是YarnFlinkResourceManager的实例。它是用来跟YARN进行交互的类。</li>
<li>最后创建两个用来在异常发生时进行清理工作的reaper。</li>
</ul>
</li>
<li>这样Flink集群算是启动起来了，然后就是等待任务执行结束，再进行退出的逻辑</li>
</ul>
<p>下面重点介绍一下刚刚提到的YarnFlinkResourceManager类。由于它是一个Actor对象，先从它的生命周期的prestart开始看，由于它没有prestart方法，追踪到它的父类FlinkResourceManager：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//位置：flink/flink-runtime/src/main/java/org/apache/flink/runtime/clusterframework/FlinkResourceManager.java</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">preStart</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="comment">// we start our leader retrieval service to make sure we get informed</span></span><br><span class="line">			<span class="comment">// about JobManager leader changes</span></span><br><span class="line">			leaderRetriever.start(<span class="keyword">new</span> <span class="title class_">LeaderRetrievalListener</span>() &#123;</span><br><span class="line"></span><br><span class="line">				<span class="meta">@Override</span></span><br><span class="line">				<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">notifyLeaderAddress</span><span class="params">(String leaderAddress, UUID leaderSessionID)</span> &#123;</span><br><span class="line">					self().tell(</span><br><span class="line">						<span class="keyword">new</span> <span class="title class_">NewLeaderAvailable</span>(leaderAddress, leaderSessionID),</span><br><span class="line">						ActorRef.noSender());</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="meta">@Override</span></span><br><span class="line">				<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleError</span><span class="params">(Exception e)</span> &#123;</span><br><span class="line">					self().tell(</span><br><span class="line">						<span class="keyword">new</span> <span class="title class_">FatalErrorOccurred</span>(<span class="string">&quot;Leader retrieval service failed&quot;</span>, e),</span><br><span class="line">						ActorRef.noSender());</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;);</span><br><span class="line"></span><br><span class="line">			<span class="comment">// framework specific initialization</span></span><br><span class="line">			initialize();</span><br><span class="line"></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">			self().tell(</span><br><span class="line">				<span class="keyword">new</span> <span class="title class_">FatalErrorOccurred</span>(<span class="string">&quot;Error during startup of ResourceManager actor&quot;</span>, t),</span><br><span class="line">				ActorRef.noSender());</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>在这个方法中，先是声明了一个回调用来监听jobmanager的Leader的变化，然后调用了initialize方法，由于YarnFlinkResourceManager类中覆盖了这个方法，因此，会调用到YarnFlinkResourceManager中，继续跟进：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//位置：flink/flink-yarn/src/main/java/org/apache/flink/yarn/YarnFlinkResourceManager.java</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initialize</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		LOG.info(<span class="string">&quot;Initializing YARN resource master&quot;</span>);</span><br><span class="line"></span><br><span class="line">		resourceManagerCallbackHandler.initialize(self());</span><br><span class="line"></span><br><span class="line">		resourceManagerClient.init(yarnConfig);</span><br><span class="line">		resourceManagerClient.start();</span><br><span class="line"></span><br><span class="line">		<span class="comment">// create the client to communicate with the node managers</span></span><br><span class="line">		nodeManagerClient.init(yarnConfig);</span><br><span class="line">		nodeManagerClient.start();</span><br><span class="line">		nodeManagerClient.cleanupRunningContainersOnStop(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// register with Resource Manager</span></span><br><span class="line">		LOG.info(<span class="string">&quot;Registering Application Master with tracking url &#123;&#125;&quot;</span>, webInterfaceURL);</span><br><span class="line"></span><br><span class="line">		scala.Option&lt;Object&gt; portOption = AkkaUtils.getAddress(getContext().system()).port();</span><br><span class="line">		<span class="type">int</span> <span class="variable">actorSystemPort</span> <span class="operator">=</span> portOption.isDefined() ? (<span class="type">int</span>) portOption.get() : -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">		<span class="type">RegisterApplicationMasterResponse</span> <span class="variable">response</span> <span class="operator">=</span> resourceManagerClient.registerApplicationMaster(</span><br><span class="line">			applicationMasterHostName, actorSystemPort, webInterfaceURL);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// if this application master starts as part of an ApplicationMaster/JobManager recovery,</span></span><br><span class="line">		<span class="comment">// then some worker containers are most likely still alive and we can re-obtain them</span></span><br><span class="line">		List&lt;Container&gt; containersFromPreviousAttempts =</span><br><span class="line">			applicationMasterResponseReflector.getContainersFromPreviousAttempts(response);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!containersFromPreviousAttempts.isEmpty()) &#123;</span><br><span class="line">			LOG.info(<span class="string">&quot;Retrieved &#123;&#125; TaskManagers from previous attempt&quot;</span>, containersFromPreviousAttempts.size());</span><br><span class="line"></span><br><span class="line">			<span class="keyword">final</span> <span class="type">long</span> <span class="variable">now</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">			<span class="keyword">for</span> (Container c : containersFromPreviousAttempts) &#123;</span><br><span class="line">				<span class="type">YarnContainerInLaunch</span> <span class="variable">containerInLaunch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">YarnContainerInLaunch</span>(c, now);</span><br><span class="line">				containersInLaunch.put(containerInLaunch.getResourceID(), containerInLaunch);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// adjust the progress indicator</span></span><br><span class="line">			updateProgress();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>这里初始化了以下几个关键的成员：</p>
<ul>
<li>resourceManagerCallbackHandler：用来处理YARN RM发过来的消息回调的</li>
<li>resourceManagerClient：用来向YARN RM发送请求的</li>
<li>nodeManagerClient：用来向YARN NM发送请求的</li>
</ul>
<p>接下来，调用了resourceManagerClient.registerApplicationMaster方法来向YARN RM注册当前的AppMaster。下面继续跟进到这个方法里面(这个方法的实现在hadoop的源码中)：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//位置：.m2/repository/org/apache/hadoop/hadoop-yarn-client/2.4.1/hadoop-yarn-client-2.4.1-sources.jar!/org/apache/hadoop/yarn/client/api/async/impl/AMRMClientAsyncImpl.java</span></span><br><span class="line">    <span class="keyword">public</span> RegisterApplicationMasterResponse <span class="title function_">registerApplicationMaster</span><span class="params">(String appHostName, <span class="type">int</span> appHostPort, String appTrackingUrl)</span> <span class="keyword">throws</span> YarnException, IOException &#123;</span><br><span class="line">        <span class="type">RegisterApplicationMasterResponse</span> <span class="variable">response</span> <span class="operator">=</span> <span class="built_in">this</span>.client.registerApplicationMaster(appHostName, appHostPort, appTrackingUrl);</span><br><span class="line">        <span class="built_in">this</span>.heartbeatThread.start();</span><br><span class="line">        <span class="keyword">return</span> response;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这里面首先是调用了this.client.registerApplicationMaster向RM申请注册，然后调用了heartbeatThread.start用来启动心跳服务。默认的，AM与RM的心跳中会携带要申请的container的信息。</p>
<p>在RM确认了可以分配的container信息后，会回调resourceManagerCallbackHandler的onContainersAllocated方法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//位置：flink/flink-yarn/src/main/java/org/apache/flink/yarn/YarnResourceManagerCallbackHandler.java</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onContainersAllocated</span><span class="params">(List&lt;Container&gt; containers)</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (yarnFrameworkMaster != <span class="literal">null</span>) &#123;</span><br><span class="line">			yarnFrameworkMaster.tell(</span><br><span class="line">				<span class="keyword">new</span> <span class="title class_">ContainersAllocated</span>(containers),</span><br><span class="line">				ActorRef.noSender());</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>继续跟进到YarnFlinkResourceManager中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//位置：flink/flink-yarn/src/main/java/org/apache/flink/yarn/YarnFlinkResourceManager.java</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">handleMessage</span><span class="params">(Object message)</span> &#123;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// check for YARN specific actor messages first</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (message <span class="keyword">instanceof</span> ContainersAllocated) &#123;</span><br><span class="line">			containersAllocated(((ContainersAllocated) message).containers());</span><br><span class="line"></span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (message <span class="keyword">instanceof</span> ContainersComplete) &#123;</span><br><span class="line">			containersComplete(((ContainersComplete) message).containers());</span><br><span class="line"></span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">// message handled by the generic resource master code</span></span><br><span class="line">			<span class="built_in">super</span>.handleMessage(message);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>这里会调用containersAllocated方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//位置：flink/flink-yarn/src/main/java/org/apache/flink/yarn/YarnFlinkResourceManager.java</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">containersAllocated</span><span class="params">(List&lt;Container&gt; containers)</span> &#123;</span><br><span class="line">		<span class="keyword">final</span> <span class="type">int</span> <span class="variable">numRequired</span> <span class="operator">=</span> getDesignatedWorkerPoolSize();</span><br><span class="line">		<span class="keyword">final</span> <span class="type">int</span> <span class="variable">numRegistered</span> <span class="operator">=</span> getNumberOfStartedTaskManagers();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> (Container container : containers) &#123;</span><br><span class="line">			numPendingContainerRequests = Math.max(<span class="number">0</span>, numPendingContainerRequests - <span class="number">1</span>);</span><br><span class="line">			LOG.info(<span class="string">&quot;Received new container: &#123;&#125; - Remaining pending container requests: &#123;&#125;&quot;</span>,</span><br><span class="line">				container.getId(), numPendingContainerRequests);</span><br><span class="line"></span><br><span class="line">			<span class="comment">// decide whether to return the container, or whether to start a TaskManager</span></span><br><span class="line">			<span class="keyword">if</span> (numRegistered + containersInLaunch.size() &lt; numRequired) &#123;</span><br><span class="line">				<span class="comment">// start a TaskManager</span></span><br><span class="line">				<span class="keyword">final</span> <span class="type">YarnContainerInLaunch</span> <span class="variable">containerInLaunch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">YarnContainerInLaunch</span>(container);</span><br><span class="line">				<span class="keyword">final</span> <span class="type">ResourceID</span> <span class="variable">resourceID</span> <span class="operator">=</span> containerInLaunch.getResourceID();</span><br><span class="line">				containersInLaunch.put(resourceID, containerInLaunch);</span><br><span class="line"></span><br><span class="line">				<span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;Launching TaskManager in container &quot;</span> + containerInLaunch</span><br><span class="line">					+ <span class="string">&quot; on host &quot;</span> + container.getNodeId().getHost();</span><br><span class="line">				LOG.info(message);</span><br><span class="line">				sendInfoMessage(message);</span><br><span class="line"></span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					<span class="comment">// set a special environment variable to uniquely identify this container</span></span><br><span class="line">					taskManagerLaunchContext.getEnvironment()</span><br><span class="line">						.put(ENV_FLINK_CONTAINER_ID, resourceID.getResourceIdString());</span><br><span class="line">					nodeManagerClient.startContainer(container, taskManagerLaunchContext);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">					<span class="comment">// failed to launch the container</span></span><br><span class="line">					containersInLaunch.remove(resourceID);</span><br><span class="line"></span><br><span class="line">					<span class="comment">// return container, a new one will be requested eventually</span></span><br><span class="line">					LOG.error(<span class="string">&quot;Could not start TaskManager in container &quot;</span> + containerInLaunch, t);</span><br><span class="line">					containersBeingReturned.put(container.getId(), container);</span><br><span class="line">					resourceManagerClient.releaseAssignedContainer(container.getId());</span><br><span class="line">				&#125;</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="comment">// return excessive container</span></span><br><span class="line">				LOG.info(<span class="string">&quot;Returning excess container &#123;&#125;&quot;</span>, container.getId());</span><br><span class="line">				containersBeingReturned.put(container.getId(), container);</span><br><span class="line">				resourceManagerClient.releaseAssignedContainer(container.getId());</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		updateProgress();</span><br><span class="line"></span><br><span class="line">		<span class="comment">// if we are waiting for no further containers, we can go to the</span></span><br><span class="line">		<span class="comment">// regular heartbeat interval</span></span><br><span class="line">		<span class="keyword">if</span> (numPendingContainerRequests &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">			resourceManagerClient.setHeartbeatInterval(yarnHeartbeatIntervalMillis);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// make sure we re-check the status of workers / containers one more time at least,</span></span><br><span class="line">		<span class="comment">// in case some containers did not come up properly</span></span><br><span class="line">		triggerCheckWorkers();</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>这个方法就是在通过nodeManagerClient来在各个nodemanager上面把由yarn返回的结果，进行真正的拉起。到了这里，taskmanager就都启动起来了</p>
<p>下面回到一开始的地方，找到CliFrontend的executeProgram方法，这个方法是在刚刚的流程结束之后，用来向jobmanager提交一个flink的job。</p>
<h1 id="5-提交flink-job"><a href="#5-提交flink-job" class="headerlink" title="5. 提交flink job"></a>5. 提交flink job</h1><p>上面的流程中已经完成了整个flink cluster的各个角色的启动，接下来，是向这个cluster提交一个job。</p>
<p>下面继续跟进executeProgram函数，它的主要功能是让Client通过Actor提交程序到JobManager：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//位置：flink/flink-clients/src/main/java/org/apache/flink/client/CliFrontend.java</span></span><br><span class="line">	<span class="keyword">protected</span> <span class="type">int</span> <span class="title function_">executeProgram</span><span class="params">(PackagedProgram program, ClusterClient client, <span class="type">int</span> parallelism)</span> &#123;</span><br><span class="line">		logAndSysout(<span class="string">&quot;Starting execution of program&quot;</span>);</span><br><span class="line"></span><br><span class="line">		JobSubmissionResult result;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			result = client.run(program, parallelism);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (ProgramParametrizationException e) &#123;</span><br><span class="line">			<span class="keyword">return</span> handleParametrizationException(e);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (ProgramMissingJobException e) &#123;</span><br><span class="line">			<span class="keyword">return</span> handleMissingJobException();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (ProgramInvocationException e) &#123;</span><br><span class="line">			<span class="keyword">return</span> handleError(e);</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			program.deleteExtractedLibraries();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (<span class="literal">null</span> == result) &#123;</span><br><span class="line">			logAndSysout(<span class="string">&quot;No JobSubmissionResult returned, please make sure you called &quot;</span> +</span><br><span class="line">				<span class="string">&quot;ExecutionEnvironment.execute()&quot;</span>);</span><br><span class="line">			<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (result.isJobExecutionResult()) &#123;</span><br><span class="line">			logAndSysout(<span class="string">&quot;Program execution finished&quot;</span>);</span><br><span class="line">			<span class="type">JobExecutionResult</span> <span class="variable">execResult</span> <span class="operator">=</span> result.getJobExecutionResult();</span><br><span class="line">			System.out.println(<span class="string">&quot;Job with JobID &quot;</span> + execResult.getJobID() + <span class="string">&quot; has finished.&quot;</span>);</span><br><span class="line">			System.out.println(<span class="string">&quot;Job Runtime: &quot;</span> + execResult.getNetRuntime() + <span class="string">&quot; ms&quot;</span>);</span><br><span class="line">			Map&lt;String, Object&gt; accumulatorsResult = execResult.getAllAccumulatorResults();</span><br><span class="line">			<span class="keyword">if</span> (accumulatorsResult.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">				System.out.println(<span class="string">&quot;Accumulator Results: &quot;</span>);</span><br><span class="line">				System.out.println(AccumulatorHelper.getResultsFormatted(accumulatorsResult));</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			logAndSysout(<span class="string">&quot;Job has been submitted with JobID &quot;</span> + result.getJobID());</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>这个函数中最重要的是调用了result &#x3D; client.run(program, parallelism)，剩下的都是一些收集的工作，这里的client是YarnClusterClient，但是由于没有覆盖run(program, parallelism)这个方法，下面继续跟进到基类中的client.run(program, parallelism)：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//位置：flink/flink-clients/src/main/java/org/apache/flink/client/program/ClusterClient.java</span></span><br><span class="line">	<span class="keyword">public</span> JobSubmissionResult <span class="title function_">run</span><span class="params">(PackagedProgram prog, <span class="type">int</span> parallelism)</span></span><br><span class="line">			<span class="keyword">throws</span> ProgramInvocationException, ProgramMissingJobException &#123;</span><br><span class="line">		Thread.currentThread().setContextClassLoader(prog.getUserCodeClassLoader());</span><br><span class="line">		<span class="keyword">if</span> (prog.isUsingProgramEntryPoint()) &#123;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">final</span> JobWithJars jobWithJars;</span><br><span class="line">			<span class="keyword">if</span> (hasUserJarsInClassPath(prog.getAllLibraries())) &#123;</span><br><span class="line">				jobWithJars = prog.getPlanWithoutJars();</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				jobWithJars = prog.getPlanWithJars();</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">return</span> run(jobWithJars, parallelism, prog.getSavepointSettings());</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (prog.isUsingInteractiveMode()) &#123;</span><br><span class="line">			log.info(<span class="string">&quot;Starting program in interactive mode&quot;</span>);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">final</span> List&lt;URL&gt; libraries;</span><br><span class="line">			<span class="keyword">if</span> (hasUserJarsInClassPath(prog.getAllLibraries())) &#123;</span><br><span class="line">				libraries = Collections.emptyList();</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				libraries = prog.getAllLibraries();</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="type">ContextEnvironmentFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ContextEnvironmentFactory</span>(<span class="built_in">this</span>, libraries,</span><br><span class="line">					prog.getClasspaths(), prog.getUserCodeClassLoader(), parallelism, isDetached(),</span><br><span class="line">					prog.getSavepointSettings());</span><br><span class="line">			ContextEnvironment.setAsContext(factory);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				<span class="comment">// invoke main method</span></span><br><span class="line">				prog.invokeInteractiveModeForExecution();</span><br><span class="line">				<span class="keyword">if</span> (lastJobExecutionResult == <span class="literal">null</span> &amp;&amp; factory.getLastEnvCreated() == <span class="literal">null</span>) &#123;</span><br><span class="line">					<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ProgramMissingJobException</span>();</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span> (isDetached()) &#123;</span><br><span class="line">					<span class="comment">// in detached mode, we execute the whole user code to extract the Flink job, afterwards we run it here</span></span><br><span class="line">					<span class="keyword">return</span> ((DetachedEnvironment) factory.getLastEnvCreated()).finalizeExecute();</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span> &#123;</span><br><span class="line">					<span class="comment">// in blocking mode, we execute all Flink jobs contained in the user code and then return here</span></span><br><span class="line">					<span class="keyword">return</span> <span class="built_in">this</span>.lastJobExecutionResult;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">finally</span> &#123;</span><br><span class="line">				ContextEnvironment.unsetContext();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ProgramInvocationException</span>(<span class="string">&quot;PackagedProgram does not have a valid invocation mode.&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>这里首先是判断有没有提供入口类，然后选择模式，如果提供了入口类，就是执行jar的模式，如果没有提供，那就是交互式的编程模式。根据前面的命令，这里选择有入口类的分支。然后继续跟进到run(jobWithJars, parallelism, prog.getSavepointSettings())方法内部：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//位置：flink/flink-clients/src/main/java/org/apache/flink/client/program/ClusterClient.java</span></span><br><span class="line">	<span class="keyword">public</span> JobSubmissionResult <span class="title function_">run</span><span class="params">(JobWithJars jobWithJars, <span class="type">int</span> parallelism, SavepointRestoreSettings savepointSettings)</span></span><br><span class="line">			<span class="keyword">throws</span> CompilerException, ProgramInvocationException &#123;</span><br><span class="line">		<span class="type">ClassLoader</span> <span class="variable">classLoader</span> <span class="operator">=</span> jobWithJars.getUserCodeClassLoader();</span><br><span class="line">		<span class="keyword">if</span> (classLoader == <span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;The given JobWithJars does not provide a usercode class loader.&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="type">OptimizedPlan</span> <span class="variable">optPlan</span> <span class="operator">=</span> getOptimizedPlan(compiler, jobWithJars, parallelism);</span><br><span class="line">		<span class="keyword">return</span> run(optPlan, jobWithJars.getJarFiles(), jobWithJars.getClasspaths(), classLoader, savepointSettings);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>这里产生了一个优化过的plan(先跳过plan的部分，专注在flink on yarn的流程中)，然后继续调用了run方法，继续跟进：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//位置：flink/flink-clients/src/main/java/org/apache/flink/client/program/ClusterClient.java</span></span><br><span class="line">	<span class="keyword">public</span> JobSubmissionResult <span class="title function_">run</span><span class="params">(FlinkPlan compiledPlan,</span></span><br><span class="line"><span class="params">			List&lt;URL&gt; libraries, List&lt;URL&gt; classpaths, ClassLoader classLoader, SavepointRestoreSettings savepointSettings)</span></span><br><span class="line">			<span class="keyword">throws</span> ProgramInvocationException &#123;</span><br><span class="line">		<span class="type">JobGraph</span> <span class="variable">job</span> <span class="operator">=</span> getJobGraph(compiledPlan, libraries, classpaths, savepointSettings);</span><br><span class="line">		<span class="keyword">return</span> submitJob(job, classLoader);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>这里产生了一个JobGraph，然后提交job，继续跟进到父类YarnClusterClient中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//位置：flink/flink-yarn/src/main/java/org/apache/flink/yarn/YarnClusterClient.java</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">protected</span> JobSubmissionResult <span class="title function_">submitJob</span><span class="params">(JobGraph jobGraph, ClassLoader classLoader)</span> <span class="keyword">throws</span> ProgramInvocationException &#123;</span><br><span class="line">		<span class="keyword">if</span> (isDetached()) &#123;</span><br><span class="line">			<span class="keyword">if</span> (newlyCreatedCluster) &#123;</span><br><span class="line">				stopAfterJob(jobGraph.getJobID());</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> <span class="built_in">super</span>.runDetached(jobGraph, classLoader);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="built_in">super</span>.run(jobGraph, classLoader);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>这里先是判断是否是detached(根据参数-d)，detach的意思是，在appmaster在yarn里面启动之后，就断开与client的连接；否则就一直保持连接。如果一直保持连接的话，client这里的命令行进程退出，会杀死yarn上运行的任务。下面按照开始时设置的参数-d进入到isDetached判断内部。</p>
<p>如果这个cluster是刚刚被创建的(创建新任务的情况；反之是查询历史任务的情况)，就调用一下stopAfterJob，用来通知appmaster在运行这个job结束之后就退出。</p>
<p>接下来，继续跟进到super.runDetached方法内部：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//位置：flink/flink-clients/src/main/java/org/apache/flink/client/program/ClusterClient.java</span></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Submits a JobGraph detached.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> jobGraph The JobGraph</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> classLoader User code class loader to deserialize the results and errors (may contain custom classes).</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> JobSubmissionResult</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> ProgramInvocationException</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">public</span> JobSubmissionResult <span class="title function_">runDetached</span><span class="params">(JobGraph jobGraph, ClassLoader classLoader)</span> <span class="keyword">throws</span> ProgramInvocationException &#123;</span><br><span class="line"></span><br><span class="line">		waitForClusterToBeReady();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">final</span> ActorGateway jobManagerGateway;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			jobManagerGateway = getJobManagerGateway();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ProgramInvocationException</span>(<span class="string">&quot;Failed to retrieve the JobManager gateway.&quot;</span>, e);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			logAndSysout(<span class="string">&quot;Submitting Job with JobID: &quot;</span> + jobGraph.getJobID() + <span class="string">&quot;. Returning after job submission.&quot;</span>);</span><br><span class="line">			JobClient.submitJobDetached(jobManagerGateway, flinkConfig, jobGraph, timeout, classLoader);</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JobSubmissionResult</span>(jobGraph.getJobID());</span><br><span class="line">		&#125; <span class="keyword">catch</span> (JobExecutionException e) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ProgramInvocationException</span>(<span class="string">&quot;The program execution failed: &quot;</span> + e.getMessage(), e);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>waitForClusterToBeReady()是在等待所有taskmanager都启动起来。然后找到jobManager的gateway，通过JobClient.submitJobDetached方法提交一个jobGraph。这里已经是Flink的内部逻辑了，以后再继续分析。</p>
<hr>
<p>后记：在registerApplicationMaster的地方浪费了太多时间，找不到向yarn rm发出container资源申请的点，后面发现原来是跟着心跳一起的。</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Flink-YARN-%E6%BA%90%E7%A0%81/" rel="tag"># Flink, YARN, 源码</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/12/04/log4j%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" rel="next" title="log4j源码分析(基于1.2.17版本)">
                <i class="fa fa-chevron-left"></i> log4j源码分析(基于1.2.17版本)
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/01/12/Yarn%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%901-%E8%AE%BE%E8%AE%A1%E7%90%86%E5%BF%B5%E4%B8%8E%E5%9F%BA%E6%9C%AC%E6%9E%B6%E6%9E%84/" rel="prev" title="Yarn源码分析1-设计理念与基本架构">
                Yarn源码分析1-设计理念与基本架构 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpg"
                alt="" />
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%20%7C%7C%20archive">
              
                  <span class="site-state-item-count">16</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">10</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">14</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/yoelee" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:li.ya.kun@163.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#1-%E4%BB%8E%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%BC%80%E5%A7%8B"><span class="nav-number">1.</span> <span class="nav-text">1. 从命令行开始</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-%E5%89%8D%E7%AB%AF%E5%A4%84%E7%90%86"><span class="nav-number">2.</span> <span class="nav-text">2. 前端处理</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-%E4%B8%8EYarn%E4%BA%A4%E4%BA%92"><span class="nav-number">3.</span> <span class="nav-text">3. 与Yarn交互</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#4-YarnApplicationMasterRunner"><span class="nav-number">4.</span> <span class="nav-text">4. YarnApplicationMasterRunner</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#5-%E6%8F%90%E4%BA%A4flink-job"><span class="nav-number">5.</span> <span class="nav-text">5. 提交flink job</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">亚坤</span>

  
</div>









        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
